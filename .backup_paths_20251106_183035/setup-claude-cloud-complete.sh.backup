#!/usr/bin/env bash
# setup-claude-cloud-complete.sh
# Setup completo e integraÃ§Ã£o 100% do Claude Cloud com governanÃ§a automatizada

set -euo pipefail

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

# DiretÃ³rios
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$HOME/Dotfiles"
CONTEXT_DIR="$DOTFILES_DIR/context-engineering"
CLAUDE_KNOWLEDGE_DIR="$DOTFILES_DIR/claude-cloud-knowledge"
OP_CONFIG_DIR="$HOME/.config/op"

# FunÃ§Ãµes de logging
log_info() { echo -e "${BLUE}â„¹${NC} $1"; }
log_success() { echo -e "${GREEN}âœ…${NC} $1"; }
log_error() { echo -e "${RED}âŒ${NC} $1" >&2; }
log_warning() { echo -e "${YELLOW}âš ï¸${NC} $1"; }
log_section() {
    echo ""
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}$1${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

# Configurar 1Password CLI
setup_1password() {
    log_section "ðŸ” Configurando 1Password CLI"

    if ! command -v op &> /dev/null; then
        log_error "1Password CLI nÃ£o encontrado"
        return 1
    fi

    # Verificar autenticaÃ§Ã£o
    if ! op whoami &>/dev/null; then
        log_warning "NÃ£o autenticado no 1Password. Fazendo login..."
        op signin || {
            log_error "Falha ao fazer login no 1Password"
            return 1
        }
    fi

    log_success "1Password CLI configurado"
}

# Obter credenciais do 1Password
get_credential() {
    local item_name="$1"
    local vault="${2:-1p_macos}"
    local field="${3:-credential}"

    # Tentar diferentes nomes e vaults
    op item get "$item_name" --vault "$vault" --fields "$field" --reveal 2>/dev/null || \
    op item get "$item_name" --vault "1p_vps" --fields "$field" --reveal 2>/dev/null || \
    op item get "$item_name" --vault "1p_macos" --fields "password" --reveal 2>/dev/null || \
    echo ""
}

# Verificar e configurar ANTHROPIC_API_KEY
setup_anthropic_api_key() {
    log_section "ðŸ”‘ Configurando ANTHROPIC_API_KEY"

    API_KEY=$(get_credential "ce5jhu6mivh4g63lzfxlj3r2cu" "1p_macos" "credential" || \
              get_credential "Anthropic-API" "1p_macos" "credential")

    if [ -z "$API_KEY" ]; then
        log_error "ANTHROPIC_API_KEY nÃ£o encontrada no 1Password"
        return 1
    fi

    export ANTHROPIC_API_KEY="$API_KEY"

    # Adicionar ao shell config
    local shell_config
    if [ -n "${ZSH_VERSION:-}" ]; then
        shell_config="$HOME/.zshrc"
    else
        shell_config="$HOME/.bashrc"
    fi

    if ! grep -q "ANTHROPIC_API_KEY" "$shell_config" 2>/dev/null; then
        cat >> "$shell_config" << 'EOF'

# Claude Cloud - ANTHROPIC_API_KEY do 1Password
if command -v op &> /dev/null && [ -f "$HOME/.config/op/op_config.sh" ]; then
    source "$HOME/.config/op/op_config.sh" 2>/dev/null || true
    export ANTHROPIC_API_KEY=$(op item get "ce5jhu6mivh4g63lzfxlj3r2cu" --vault "1p_macos" --fields "credential" --reveal 2>/dev/null || \
                     op item get "Anthropic-API" --vault "1p_macos" --fields "credential" --reveal 2>/dev/null || \
                     echo "")
fi
EOF
        log_success "ANTHROPIC_API_KEY configurada no $shell_config"
    fi

    log_success "ANTHROPIC_API_KEY configurada (${#API_KEY} caracteres)"
}

# Verificar Claude Code
setup_claude_code() {
    log_section "ðŸ¤– Verificando Claude Code"

    if command -v claude &> /dev/null; then
        log_success "Claude Code instalado: $(claude --version 2>/dev/null || echo 'v2.0.33+')"

        # Verificar se estÃ¡ autenticado
        if [ -n "${ANTHROPIC_API_KEY:-}" ]; then
            log_success "ANTHROPIC_API_KEY configurada"
        else
            log_warning "ANTHROPIC_API_KEY nÃ£o configurada nesta sessÃ£o"
        fi
    else
        log_warning "Claude Code nÃ£o encontrado no PATH"
        log_info "Execute: npm install -g @anthropic-ai/claude-code"
    fi
}

# Configurar Claude Desktop
setup_claude_desktop() {
    log_section "ðŸ–¥ï¸  Configurando Claude Desktop"

    if [[ "$OSTYPE" != "darwin"* ]]; then
        log_warning "Claude Desktop disponÃ­vel apenas no macOS"
        return 0
    fi

    CLAUDE_CONFIG="$HOME/Library/Application Support/Claude/claude_desktop_config.json"
    CLAUDE_CONFIG_SOURCE="$CLAUDE_KNOWLEDGE_DIR/01_CONFIGURACOES/claude_desktop_config.json"

    mkdir -p "$(dirname "$CLAUDE_CONFIG")"

    if [ -f "$CLAUDE_CONFIG_SOURCE" ]; then
        # Fazer backup se existir
        if [ -f "$CLAUDE_CONFIG" ]; then
            cp "$CLAUDE_CONFIG" "${CLAUDE_CONFIG}.backup.$(date +%Y%m%d_%H%M%S)"
        fi

        cp "$CLAUDE_CONFIG_SOURCE" "$CLAUDE_CONFIG"
        log_success "Claude Desktop configurado"
    else
        log_warning "Arquivo de configuraÃ§Ã£o nÃ£o encontrado: $CLAUDE_CONFIG_SOURCE"
    fi
}

# Criar estrutura de governanÃ§a de dados
setup_data_governance() {
    log_section "ðŸ“Š Configurando GovernanÃ§a de Dados"

    GOVERNANCE_DIR="$CONTEXT_DIR/governance"
    mkdir -p "$GOVERNANCE_DIR"

    # Estrutura de governanÃ§a
    cat > "$GOVERNANCE_DIR/README.md" << 'EOF'
# GovernanÃ§a de Dados para LLMs

## ðŸ“‹ Estrutura

- `policies/` - PolÃ­ticas de governanÃ§a
- `schemas/` - Schemas de validaÃ§Ã£o
- `audit/` - Logs de auditoria
- `automation/` - Scripts de automaÃ§Ã£o

## ðŸ”„ AtualizaÃ§Ã£o AutomÃ¡tica

Os scripts de governanÃ§a sÃ£o executados automaticamente via cron ou sistema de agendamento.
EOF

    mkdir -p "$GOVERNANCE_DIR"/{policies,schemas,audit,automation}

    log_success "Estrutura de governanÃ§a criada"
}

# Criar script de atualizaÃ§Ã£o automÃ¡tica
create_auto_update_script() {
    log_section "ðŸ”„ Criando Script de AtualizaÃ§Ã£o AutomÃ¡tica"

    UPDATE_SCRIPT="$CONTEXT_DIR/governance/automation/update-claude-context.sh"

    cat > "$UPDATE_SCRIPT" << 'SCRIPT_EOF'
#!/usr/bin/env bash
# update-claude-context.sh
# AtualizaÃ§Ã£o automÃ¡tica de contexto para Claude Cloud

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONTEXT_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"
DOTFILES_DIR="$(dirname "$CONTEXT_DIR")"
CLAUDE_KNOWLEDGE_DIR="$DOTFILES_DIR/claude-cloud-knowledge"
LOG_FILE="$CONTEXT_DIR/governance/audit/update-$(date +%Y%m%d).log"

log_with_timestamp() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log_with_timestamp "ðŸ”„ Iniciando atualizaÃ§Ã£o automÃ¡tica de contexto"

# 1. Verificar autenticaÃ§Ã£o
if ! op whoami &>/dev/null; then
    log_with_timestamp "âŒ NÃ£o autenticado no 1Password"
    exit 1
fi

# 2. Executar script de consolidaÃ§Ã£o
if [ -f "$CONTEXT_DIR/scripts/consolidate-docs-for-claude.sh" ]; then
    log_with_timestamp "ðŸ“š Consolidando documentaÃ§Ã£o"
    "$CONTEXT_DIR/scripts/consolidate-docs-for-claude.sh" >> "$LOG_FILE" 2>&1
fi

# 3. Executar script de automaÃ§Ã£o Claude Cloud
if [ -f "$CONTEXT_DIR/scripts/auto-config-claude-cloud.py" ]; then
    log_with_timestamp "ðŸ¤– Executando automaÃ§Ã£o Claude Cloud"
    python3 "$CONTEXT_DIR/scripts/auto-config-claude-cloud.py" >> "$LOG_FILE" 2>&1
fi

# 4. Validar arquivos gerados
log_with_timestamp "âœ… AtualizaÃ§Ã£o concluÃ­da"

SCRIPT_EOF

    chmod +x "$UPDATE_SCRIPT"
    log_success "Script de atualizaÃ§Ã£o criado: $UPDATE_SCRIPT"
}

# Configurar cron job para atualizaÃ§Ã£o automÃ¡tica
setup_cron_job() {
    log_section "â° Configurando AtualizaÃ§Ã£o AutomÃ¡tica"

    UPDATE_SCRIPT="$CONTEXT_DIR/governance/automation/update-claude-context.sh"

    # Criar cron job (diÃ¡rio Ã s 2h da manhÃ£)
    CRON_JOB="0 2 * * * $UPDATE_SCRIPT"

    # Verificar se jÃ¡ existe
    if crontab -l 2>/dev/null | grep -q "$UPDATE_SCRIPT"; then
        log_warning "Cron job jÃ¡ existe"
    else
        log_info "Adicionando cron job para atualizaÃ§Ã£o diÃ¡ria Ã s 2h"
        (crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -
        log_success "Cron job configurado"
    fi
}

# Validar integraÃ§Ãµes
validate_integrations() {
    log_section "âœ… Validando IntegraÃ§Ãµes"

    local errors=0

    # Verificar 1Password
    if command -v op &> /dev/null; then
        if op whoami &>/dev/null; then
            log_success "1Password: Autenticado"
        else
            log_error "1Password: NÃ£o autenticado"
            errors=$((errors + 1))
        fi
    else
        log_error "1Password: CLI nÃ£o instalado"
        errors=$((errors + 1))
    fi

    # Verificar ANTHROPIC_API_KEY
    if [ -n "${ANTHROPIC_API_KEY:-}" ]; then
        log_success "ANTHROPIC_API_KEY: Configurada (${#ANTHROPIC_API_KEY} caracteres)"
    else
        log_warning "ANTHROPIC_API_KEY: NÃ£o configurada nesta sessÃ£o"
    fi

    # Verificar Claude Code
    if command -v claude &> /dev/null; then
        log_success "Claude Code: Instalado"
    else
        log_warning "Claude Code: NÃ£o encontrado"
    fi

    # Verificar estrutura de diretÃ³rios
    if [ -d "$CLAUDE_KNOWLEDGE_DIR" ]; then
        log_success "Claude Knowledge: Estrutura encontrada"
    else
        log_error "Claude Knowledge: Estrutura nÃ£o encontrada"
        errors=$((errors + 1))
    fi

    # Verificar scripts
    local scripts=(
        "scripts/sync-profiles.sh"
        "scripts/claude-code-setup.sh"
        "scripts/auto-config-claude-cloud.py"
    )

    for script in "${scripts[@]}"; do
        if [ -f "$CONTEXT_DIR/$script" ]; then
            log_success "Script: $script encontrado"
        else
            log_warning "Script: $script nÃ£o encontrado"
        fi
    done

    return $errors
}

# Criar documento de melhores prÃ¡ticas atualizado
create_best_practices() {
    log_section "ðŸ“š Criando Documento de Melhores PrÃ¡ticas"

    BEST_PRACTICES="$CONTEXT_DIR/MELHORES_PRATICAS.md"

    cat > "$BEST_PRACTICES" << 'EOF'
# Melhores PrÃ¡ticas - Engenharia de Contexto e GovernanÃ§a de Dados

## ðŸŽ¯ PrincÃ­pios Fundamentais

### 1. Contexto Rico e Estruturado
- Sempre fornecer contexto completo do ambiente
- Organizar informaÃ§Ãµes hierarquicamente
- Usar templates padronizados
- Manter documentaÃ§Ã£o atualizada

### 2. SeguranÃ§a e AutenticaÃ§Ã£o
- **NUNCA** hardcodar secrets
- Usar 1Password para todos os tokens
- Rotacionar credenciais regularmente
- Validar autenticaÃ§Ã£o antes de operaÃ§Ãµes crÃ­ticas

### 3. GovernanÃ§a de Dados
- Estrutura de dados padronizada
- ValidaÃ§Ã£o automÃ¡tica de schemas
- Auditoria de mudanÃ§as
- Versionamento de configuraÃ§Ãµes

### 4. AutomaÃ§Ã£o e AtualizaÃ§Ã£o
- Scripts reutilizÃ¡veis e idempotentes
- AtualizaÃ§Ã£o automÃ¡tica de contexto
- Backup antes de mudanÃ§as
- Logging de todas as operaÃ§Ãµes

## ðŸ” AutenticaÃ§Ã£o e Credenciais

### Fluxo de AutenticaÃ§Ã£o

1. **1Password CLI**: Fonte Ãºnica de verdade para secrets
2. **VariÃ¡veis de Ambiente**: Configuradas via shell config
3. **ValidaÃ§Ã£o**: Verificar antes de usar
4. **RotaÃ§Ã£o**: Processo automatizado

### Credenciais Principais

| Credencial | Fonte | Uso |
|------------|-------|-----|
| ANTHROPIC_API_KEY | 1Password (ID: ce5jhu6mivh4g63lzfxlj3r2cu) | Claude API |
| GitHub Token | 1Password | GitHub CLI |
| Hugging Face Token | 1Password | HF CLI |
| SSH Keys | 1Password | Git/Acesso remoto |

## ðŸ“Š GovernanÃ§a de Dados Automatizada

### Estrutura de GovernanÃ§a

```
governance/
â”œâ”€â”€ policies/          # PolÃ­ticas de governanÃ§a
â”œâ”€â”€ schemas/           # Schemas de validaÃ§Ã£o
â”œâ”€â”€ audit/             # Logs de auditoria
â””â”€â”€ automation/        # Scripts de automaÃ§Ã£o
```

### Processo de AtualizaÃ§Ã£o AutomÃ¡tica

1. **DiÃ¡rio (2h da manhÃ£)**:
   - Consolidar documentaÃ§Ã£o
   - Atualizar contexto Claude Cloud
   - Validar configuraÃ§Ãµes
   - Gerar relatÃ³rios

2. **Sempre que necessÃ¡rio**:
   - Executar `sync-profiles.sh` apÃ³s mudanÃ§as
   - Executar `auto-config-claude-cloud.py` apÃ³s atualizaÃ§Ãµes
   - Validar autenticaÃ§Ã£o antes de operaÃ§Ãµes crÃ­ticas

### ValidaÃ§Ã£o AutomÃ¡tica

- Schemas JSON para configuraÃ§Ãµes
- ValidaÃ§Ã£o de paths e permissÃµes
- VerificaÃ§Ã£o de integridade de arquivos
- Testes de conectividade de APIs

## ðŸ”„ SincronizaÃ§Ã£o Entre Ambientes

### Fluxo de SincronizaÃ§Ã£o

1. **Desenvolvimento (macOS)**:
   - Fazer mudanÃ§as locais
   - Testar configuraÃ§Ãµes
   - Commitar no Git

2. **SincronizaÃ§Ã£o**:
   - Git push para repositÃ³rio
   - Pull no VPS
   - Executar `sync-profiles.sh`

3. **ValidaÃ§Ã£o**:
   - Verificar diferenÃ§as
   - Testar configuraÃ§Ãµes
   - Documentar mudanÃ§as

## ðŸ“ Estrutura de Contexto para LLMs

### OrganizaÃ§Ã£o HierÃ¡rquica

```
Claude Cloud Knowledge/
â”œâ”€â”€ 00_CONTEXTO_GLOBAL/    # Contexto base (sempre carregado primeiro)
â”œâ”€â”€ 01_CONFIGURACOES/      # ConfiguraÃ§Ãµes e autenticaÃ§Ã£o
â”œâ”€â”€ 02_PROJETO_BNI/        # Contexto especÃ­fico do projeto
â”œâ”€â”€ 03_AUTOMACAO/          # Scripts e automaÃ§Ãµes
â”œâ”€â”€ 04_REFERENCIAS/        # ReferÃªncias e guias
â”œâ”€â”€ 05_SKILLS/             # Skills e especializaÃ§Ãµes
â””â”€â”€ 06_MCP/                # MCP servers e configuraÃ§Ã£o
```

### PrincÃ­pios de OrganizaÃ§Ã£o

1. **Progressividade**: Do geral para o especÃ­fico
2. **Modularidade**: Cada seÃ§Ã£o independente
3. **Rastreabilidade**: Versionamento e auditoria
4. **AtualizaÃ§Ã£o**: Processo automatizado

## ðŸ¤– AutomaÃ§Ã£o de Contexto

### Scripts Principais

1. **consolidate-docs-for-claude.sh**:
   - Consolida documentaÃ§Ã£o de mÃºltiplas fontes
   - Gera arquivos estruturados
   - Valida formato e conteÃºdo

2. **auto-config-claude-cloud.py**:
   - Verifica MCP conectado
   - Revisa arquivos de contexto
   - Gera prompt para upload
   - Cria relatÃ³rio

3. **sync-profiles.sh**:
   - Sincroniza VSCode/Cursor
   - Atualiza Cursor Rules
   - MantÃ©m consistÃªncia entre ambientes

### Gatilhos de AtualizaÃ§Ã£o

- **MudanÃ§as em dotfiles**: Git hooks
- **AtualizaÃ§Ã£o diÃ¡ria**: Cron job
- **MudanÃ§as em configuraÃ§Ãµes**: Scripts de setup
- **Novas integraÃ§Ãµes**: Scripts especÃ­ficos

## ðŸ” ValidaÃ§Ã£o e Qualidade

### Checklist de ValidaÃ§Ã£o

Antes de fazer upload no Claude Cloud:

- [ ] Todos os arquivos revisados
- [ ] AutenticaÃ§Ã£o verificada
- [ ] Paths validados
- [ ] Sem secrets hardcoded
- [ ] DocumentaÃ§Ã£o atualizada
- [ ] Scripts testados

### Testes AutomÃ¡ticos

- ValidaÃ§Ã£o de JSON/YAML
- VerificaÃ§Ã£o de paths
- Testes de conectividade
- ValidaÃ§Ã£o de schemas

## ðŸ“š ReferÃªncias

- [Context Engineering Best Practices](https://docs.anthropic.com/claude/docs)
- [GovernanÃ§a de Dados](governance/policies/)
- [Templates](templates/)

---

**Ãšltima atualizaÃ§Ã£o**: 2025-01-15
**Status**: âœ… Implementado
EOF

    log_success "Documento de melhores prÃ¡ticas criado"
}

# FunÃ§Ã£o principal
main() {
    echo -e "${MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${MAGENTA}ðŸš€ Setup Completo Claude Cloud${NC}"
    echo -e "${MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${BLUE}Sistema:${NC} $(uname -s)"
    echo -e "${BLUE}UsuÃ¡rio:${NC} $(whoami)"
    echo ""

    # Executar todas as etapas
    setup_1password || exit 1
    setup_anthropic_api_key || exit 1
    setup_claude_code
    setup_claude_desktop
    setup_data_governance
    create_auto_update_script
    create_best_practices

    # Sincronizar perfis
    log_section "ðŸ”„ Sincronizando Perfis"
    "$CONTEXT_DIR/scripts/sync-profiles.sh" || log_warning "Falha na sincronizaÃ§Ã£o de perfis"

    # Validar tudo
    validate_integrations

    log_section "âœ… Setup ConcluÃ­do"

    echo -e "${GREEN}âœ… Claude Cloud 100% integrado e configurado${NC}"
    echo ""
    echo -e "${BLUE}ðŸ“ PrÃ³ximos passos:${NC}"
    echo "   1. Recarregue seu shell: source ~/.zshrc"
    echo "   2. Verifique autenticaÃ§Ã£o: op whoami"
    echo "   3. Teste Claude Code: claude doctor"
    echo "   4. Execute atualizaÃ§Ã£o: ./governance/automation/update-claude-context.sh"
    echo ""
}

main "$@"

