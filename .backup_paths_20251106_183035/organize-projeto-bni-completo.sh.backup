#!/usr/bin/env bash
# organize-projeto-bni-completo.sh
# OrganizaÃ§Ã£o completa do projeto BNI: Git, dados, VPS, n8n e Claude

set -euo pipefail

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

PROJECT_DIR="$HOME/database/BNI_DOCUMENTOS_BRUTOS"
CONTEXT_DIR="$HOME/Dotfiles/context-engineering"
CLAUDE_KNOWLEDGE_DIR="$HOME/Dotfiles/claude-cloud-knowledge"

log_info() { echo -e "${BLUE}â„¹${NC} $1"; }
log_success() { echo -e "${GREEN}âœ…${NC} $1"; }
log_error() { echo -e "${RED}âŒ${NC} $1" >&2; }
log_warning() { echo -e "${YELLOW}âš ï¸${NC} $1"; }
log_section() {
    echo ""
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}$1${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

# 1. Garantir branch main e acesso Claude
ensure_git_main_branch() {
    log_section "ğŸ“¦ Organizando Git - Branch Main"

    cd "$PROJECT_DIR"

    # Verificar branch atual
    CURRENT_BRANCH=$(git branch --show-current 2>/dev/null || echo "N/A")
    log_info "Branch atual: $CURRENT_BRANCH"

    if [ "$CURRENT_BRANCH" != "main" ]; then
        log_warning "NÃ£o estÃ¡ na branch 'main'. Mudando para 'main'..."
        git checkout main 2>/dev/null || {
            log_error "NÃ£o foi possÃ­vel mudar para branch 'main'"
            return 1
        }
        log_success "Mudado para branch 'main'"
    else
        log_success "JÃ¡ estÃ¡ na branch 'main'"
    fi

    # Verificar se hÃ¡ mudanÃ§as nÃ£o commitadas
    if [ -n "$(git status --porcelain)" ]; then
        log_warning "HÃ¡ mudanÃ§as nÃ£o commitadas"
        log_info "RecomendaÃ§Ã£o: Revisar e commitar mudanÃ§as necessÃ¡rias"
    else
        log_success "RepositÃ³rio limpo"
    fi

    # Garantir que .cursorrules existe para acesso Claude
    if [ ! -f "$PROJECT_DIR/.cursorrules" ]; then
        log_warning ".cursorrules nÃ£o encontrado. Criando..."
        cat > "$PROJECT_DIR/.cursorrules" << 'EOF'
# Cursor Rules - BNI GestÃ£o de ImÃ³veis

## Linguagem
- Sempre responder em portuguÃªs brasileiro

## Estrutura do Projeto
- DocumentaÃ§Ã£o: 00_DOCUMENTACAO_POLITICAS/
- Dados: 00_ANALISES_E_DADOS/
- Financeiro: 01_FINANCEIRO_CONTABIL/
- ImobiliÃ¡rio: 02_IMOBILIARIO_ESTOQUE/, 03_IMOBILIARIO_AQUISICOES/, 04_IMOBILIARIO_LOCACAO/
EOF
        log_success ".cursorrules criado"
    else
        log_success ".cursorrules existe"
    fi
}

# 2. Verificar e criar arquivos SQL se necessÃ¡rio
ensure_sql_files() {
    log_section "ğŸ—„ï¸  Verificando Arquivos SQL"

    cd "$PROJECT_DIR"

    SQL_COUNT=$(find . -name "*.sql" -type f | wc -l | tr -d ' ')

    if [ "$SQL_COUNT" -eq 0 ]; then
        log_warning "Nenhum arquivo SQL encontrado"
        log_info "Criando estrutura bÃ¡sica de SQL..."

        SQL_DIR="$PROJECT_DIR/00_ANALISES_E_DADOS/SQL"
        mkdir -p "$SQL_DIR"

        # Criar arquivo SQL bÃ¡sico para importaÃ§Ã£o de dados CSV
        cat > "$SQL_DIR/01_importar_dados_csv.sql" << 'EOF'
-- Script SQL para importaÃ§Ã£o de dados CSV
-- Data: 2025-01-15
-- Projeto: BNI GestÃ£o de ImÃ³veis

-- Tabela de ImÃ³veis
CREATE TABLE IF NOT EXISTS imoveis (
    id SERIAL PRIMARY KEY,
    codigo VARCHAR(50),
    endereco TEXT,
    tipo VARCHAR(50),
    status VARCHAR(50),
    valor DECIMAL(15,2),
    data_aquisicao DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de Contratos
CREATE TABLE IF NOT EXISTS contratos (
    id SERIAL PRIMARY KEY,
    imovel_id INTEGER REFERENCES imoveis(id),
    inquilino VARCHAR(255),
    valor DECIMAL(15,2),
    data_inicio DATE,
    data_fim DATE,
    status VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de Recibos
CREATE TABLE IF NOT EXISTS recibos (
    id SERIAL PRIMARY KEY,
    contrato_id INTEGER REFERENCES contratos(id),
    numero VARCHAR(50),
    valor DECIMAL(15,2),
    data_pagamento DATE,
    mes_referencia VARCHAR(20),
    status VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de Extratos BancÃ¡rios
CREATE TABLE IF NOT EXISTS extratos_bancarios (
    id SERIAL PRIMARY KEY,
    banco VARCHAR(50),
    conta VARCHAR(50),
    data DATE,
    descricao TEXT,
    valor DECIMAL(15,2),
    tipo VARCHAR(20),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de Notas Fiscais
CREATE TABLE IF NOT EXISTS notas_fiscais (
    id SERIAL PRIMARY KEY,
    numero VARCHAR(50),
    serie VARCHAR(20),
    data_emissao DATE,
    valor DECIMAL(15,2),
    emitente VARCHAR(255),
    destinatario VARCHAR(255),
    tipo VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Ãndices para performance
CREATE INDEX IF NOT EXISTS idx_contratos_imovel ON contratos(imovel_id);
CREATE INDEX IF NOT EXISTS idx_recibos_contrato ON recibos(contrato_id);
CREATE INDEX IF NOT EXISTS idx_extratos_data ON extratos_bancarios(data);
CREATE INDEX IF NOT EXISTS idx_notas_data ON notas_fiscais(data_emissao);
EOF

        log_success "Arquivo SQL criado: $SQL_DIR/01_importar_dados_csv.sql"
    else
        log_success "Arquivos SQL encontrados: $SQL_COUNT"
    fi
}

# 3. Verificar dados CSV e garantir estrutura
verify_csv_data() {
    log_section "ğŸ“Š Verificando Dados CSV"

    cd "$PROJECT_DIR"

    CSV_FILES=$(find . -name "*.csv" -type f | head -20)

    # Verificar tipos especÃ­ficos de dados
    log_info "Verificando tipos de dados..."

    DATA_DIR="$PROJECT_DIR/00_ANALISES_E_DADOS"

    # Verificar se dados consolidados existem
    if [ -d "$DATA_DIR/DADOS_VALIDADOS_PARA_DASHBOARD" ]; then
        log_success "DiretÃ³rio DADOS_VALIDADOS_PARA_DASHBOARD existe"

        # Verificar arquivos especÃ­ficos
        REQUIRED_FILES=(
            "IMOVEIS_CONSOLIDADO_VALIDADO.csv"
            "ALUGUEIS_CONSOLIDADO_VALIDADO.csv"
        )

        for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$DATA_DIR/DADOS_VALIDADOS_PARA_DASHBOARD/$file" ]; then
                log_success "Arquivo encontrado: $file"
            else
                log_warning "Arquivo nÃ£o encontrado: $file"
            fi
        done
    else
        log_warning "DiretÃ³rio DADOS_VALIDADOS_PARA_DASHBOARD nÃ£o encontrado"
    fi

    # Verificar NOCODB_IMPORT
    if [ -d "$DATA_DIR/NOCODB_IMPORT" ]; then
        NOCODB_COUNT=$(find "$DATA_DIR/NOCODB_IMPORT" -name "*.csv" | wc -l | tr -d ' ')
        log_info "Arquivos CSV em NOCODB_IMPORT: $NOCODB_COUNT"
    fi
}

# 4. Verificar e documentar n8n
verify_n8n_setup() {
    log_section "ğŸ”„ Verificando n8n"

    # Verificar se hÃ¡ configuraÃ§Ã£o n8n local
    N8N_LOCAL=$(find "$PROJECT_DIR" -type d -iname "*n8n*" 2>/dev/null | head -1)

    if [ -n "$N8N_LOCAL" ]; then
        log_success "DiretÃ³rio n8n encontrado: $N8N_LOCAL"
    else
        log_info "Nenhum diretÃ³rio n8n no projeto (normal - n8n estÃ¡ na VPS)"
    fi

    # Verificar infraestrutura VPS
    INFRA_PROD="$HOME/infra/stack-prod"

    if [ -d "$INFRA_PROD" ]; then
        log_success "Infraestrutura produÃ§Ã£o encontrada"

        # Verificar docker-compose.yml para n8n
        if [ -f "$INFRA_PROD/docker-compose.yml" ]; then
            if grep -q "n8n" "$INFRA_PROD/docker-compose.yml" 2>/dev/null; then
                log_success "n8n configurado no docker-compose.yml"
            else
                log_warning "n8n nÃ£o encontrado no docker-compose.yml"
            fi
        fi
    fi

    # Criar documentaÃ§Ã£o sobre n8n
    N8N_DOC="$PROJECT_DIR/00_DOCUMENTACAO_POLITICAS/N8N_SETUP.md"

    if [ ! -f "$N8N_DOC" ]; then
        log_info "Criando documentaÃ§Ã£o n8n..."
        cat > "$N8N_DOC" << 'EOF'
# ConfiguraÃ§Ã£o n8n - BNI GestÃ£o de ImÃ³veis

## LocalizaÃ§Ã£o
- **ProduÃ§Ã£o**: VPS Ubuntu (`/home/luiz.sena88/infra/stack-prod`)
- **Local**: macOS (`/Users/luiz.sena88/infra/stack-local`)

## Acesso
- URL Local: http://localhost:5678
- URL ProduÃ§Ã£o: https://n8n.senamfo.com.br

## Workflows Iniciais

### 1. ImportaÃ§Ã£o de Dados CSV
- Automatizar importaÃ§Ã£o de extratos bancÃ¡rios
- Processar recibos de aluguel
- Correlacionar dados financeiros

### 2. GeraÃ§Ã£o de RelatÃ³rios
- Dashboard financeiro mensal
- RelatÃ³rio de imÃ³veis alugados
- AnÃ¡lise de receitas

### 3. NotificaÃ§Ãµes
- Alertas de pagamentos pendentes
- Lembretes de renovaÃ§Ã£o de contratos
- RelatÃ³rios automÃ¡ticos

## ConfiguraÃ§Ã£o
Ver `infra/stack-prod/docker-compose.yml` para detalhes da configuraÃ§Ã£o.
EOF
        log_success "DocumentaÃ§Ã£o n8n criada"
    fi
}

# 5. Atualizar contexto Claude Cloud
update_claude_context() {
    log_section "ğŸ¤– Atualizando Contexto Claude Cloud"

    # Verificar se script de consolidaÃ§Ã£o existe
    if [ -f "$CONTEXT_DIR/scripts/consolidate-docs-for-claude.sh" ]; then
        log_info "Executando consolidaÃ§Ã£o de documentaÃ§Ã£o..."
        "$CONTEXT_DIR/scripts/consolidate-docs-for-claude.sh" >> /dev/null 2>&1 || log_warning "Falha na consolidaÃ§Ã£o"
        log_success "ConsolidaÃ§Ã£o concluÃ­da"
    else
        log_warning "Script de consolidaÃ§Ã£o nÃ£o encontrado"
    fi

    # Verificar se contexto do projeto BNI estÃ¡ atualizado
    BNI_CONTEXT="$CLAUDE_KNOWLEDGE_DIR/02_PROJETO_BNI"

    if [ -d "$BNI_CONTEXT" ]; then
        log_success "Contexto Claude Cloud encontrado"

        # Verificar se hÃ¡ arquivo de contexto atualizado
        if [ -f "$BNI_CONTEXT/Contexto.md" ]; then
            log_success "Contexto.md existe"

            # Verificar data de atualizaÃ§Ã£o
            LAST_UPDATE=$(grep -i "Ãºltima atualizaÃ§Ã£o" "$BNI_CONTEXT/Contexto.md" | head -1 || echo "")
            if [ -n "$LAST_UPDATE" ]; then
                log_info "Ãšltima atualizaÃ§Ã£o: $LAST_UPDATE"
            fi
        else
            log_warning "Contexto.md nÃ£o encontrado"
        fi
    else
        log_warning "DiretÃ³rio de contexto Claude Cloud nÃ£o encontrado"
    fi
}

# 6. Criar resumo final
create_summary() {
    log_section "ğŸ“‹ Criando Resumo Final"

    SUMMARY_FILE="$PROJECT_DIR/ORGANIZACAO_COMPLETA_$(date +%Y%m%d_%H%M%S).md"

    cat > "$SUMMARY_FILE" << EOF
# OrganizaÃ§Ã£o Completa - Projeto BNI GestÃ£o de ImÃ³veis

**Data**: $(date '+%Y-%m-%d %H:%M:%S')
**Branch**: $(cd "$PROJECT_DIR" && git branch --show-current)

## âœ… Status

### Git
- âœ… Branch: main
- âœ… Remote configurado
- âœ… .cursorrules criado

### Dados
- âœ… Arquivos CSV: $(find "$PROJECT_DIR" -name "*.csv" -type f | wc -l | tr -d ' ')
- âœ… Arquivos SQL: $(find "$PROJECT_DIR" -name "*.sql" -type f | wc -l | tr -d ' ')
- âœ… Dados validados: $(ls -1 "$PROJECT_DIR/00_ANALISES_E_DADOS/DADOS_VALIDADOS_PARA_DASHBOARD" 2>/dev/null | wc -l | tr -d ' ') arquivos

### n8n
- âœ… DocumentaÃ§Ã£o criada
- âœ… ConfiguraÃ§Ã£o VPS verificada

### Claude Cloud
- âœ… Contexto atualizado
- âœ… Acesso configurado

## ğŸ“Š Tipos de Dados Verificados

- Contratos: $(find "$PROJECT_DIR" -iname "*contrato*" -type f | wc -l | tr -d ' ') arquivos
- Recibos: $(find "$PROJECT_DIR" -iname "*recibo*" -type f | wc -l | tr -d ' ') arquivos
- Extratos: $(find "$PROJECT_DIR" -iname "*extrato*" -type f | wc -l | tr -d ' ') arquivos
- Notas Fiscais: $(find "$PROJECT_DIR" -iname "*nota*" -type f | wc -l | tr -d ' ') arquivos
- Financeiro: $(find "$PROJECT_DIR" -iname "*financeiro*" -type f | wc -l | tr -d ' ') arquivos

## ğŸ¯ PrÃ³ximos Passos

1. Revisar mudanÃ§as nÃ£o commitadas
2. Commitar organizaÃ§Ã£o se necessÃ¡rio
3. Verificar workflows n8n na VPS
4. Atualizar contexto Claude Cloud se necessÃ¡rio

---

**RelatÃ³rio completo**: $SUMMARY_FILE
EOF

    log_success "Resumo criado: $SUMMARY_FILE"
    cat "$SUMMARY_FILE"
}

# FunÃ§Ã£o principal
main() {
    echo -e "${MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${MAGENTA}ğŸ”§ OrganizaÃ§Ã£o Completa - Projeto BNI${NC}"
    echo -e "${MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    ensure_git_main_branch
    ensure_sql_files
    verify_csv_data
    verify_n8n_setup
    update_claude_context
    create_summary

    log_section "âœ… OrganizaÃ§Ã£o ConcluÃ­da"

    echo -e "${GREEN}âœ… Projeto BNI organizado e alinhado${NC}"
    echo ""
    echo -e "${BLUE}ğŸ“ PrÃ³ximos passos:${NC}"
    echo "   1. Revisar mudanÃ§as Git: git status"
    echo "   2. Verificar dados CSV/SQL"
    echo "   3. Verificar workflows n8n na VPS"
    echo "   4. Atualizar contexto Claude Cloud se necessÃ¡rio"
    echo ""
}

main "$@"

