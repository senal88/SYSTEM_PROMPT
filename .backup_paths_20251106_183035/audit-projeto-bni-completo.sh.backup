#!/usr/bin/env bash
# audit-projeto-bni-completo.sh
# Auditoria completa do projeto BNI: Git, dados, VPS e n8n

set -euo pipefail

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

PROJECT_DIR="$HOME/database/BNI_DOCUMENTOS_BRUTOS"
REPORT_FILE="$PROJECT_DIR/AUDITORIA_COMPLETA_$(date +%Y%m%d_%H%M%S).md"

log_info() { echo -e "${BLUE}â„¹${NC} $1"; }
log_success() { echo -e "${GREEN}âœ…${NC} $1"; }
log_error() { echo -e "${RED}âŒ${NC} $1" >&2; }
log_warning() { echo -e "${YELLOW}âš ï¸${NC} $1"; }
log_section() {
    echo ""
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}$1${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

# Iniciar relatÃ³rio
cat > "$REPORT_FILE" << EOF
# Auditoria Completa - Projeto BNI GestÃ£o de ImÃ³veis

**Data**: $(date '+%Y-%m-%d %H:%M:%S')
**LocalizaÃ§Ã£o**: $PROJECT_DIR

---

EOF

# 1. Auditoria Git
audit_git() {
    log_section "ðŸ“¦ Auditoria Git"

    cd "$PROJECT_DIR"

    cat >> "$REPORT_FILE" << EOF
## ðŸ“¦ Auditoria Git

EOF

    # Verificar se Ã© repositÃ³rio Git
    if [ ! -d ".git" ]; then
        log_error "NÃ£o Ã© um repositÃ³rio Git"
        echo "âŒ **NÃ£o Ã© um repositÃ³rio Git**" >> "$REPORT_FILE"
        return 1
    fi

    # Remote
    REMOTE=$(git remote get-url origin 2>/dev/null || echo "N/A")
    log_info "Remote: $REMOTE"
    echo "- **Remote**: \`$REMOTE\`" >> "$REPORT_FILE"

    # Branches
    log_info "Listando branches..."
    echo "" >> "$REPORT_FILE"
    echo "### Branches DisponÃ­veis" >> "$REPORT_FILE"
    echo "\`\`\`" >> "$REPORT_FILE"
    git branch -a >> "$REPORT_FILE" 2>&1
    echo "\`\`\`" >> "$REPORT_FILE"

    # Branch atual
    CURRENT_BRANCH=$(git branch --show-current 2>/dev/null || echo "N/A")
    log_info "Branch atual: $CURRENT_BRANCH"
    echo "" >> "$REPORT_FILE"
    echo "- **Branch Atual**: \`$CURRENT_BRANCH\`" >> "$REPORT_FILE"

    # Status
    log_info "Status do repositÃ³rio..."
    echo "" >> "$REPORT_FILE"
    echo "### Status do RepositÃ³rio" >> "$REPORT_FILE"
    echo "\`\`\`" >> "$REPORT_FILE"
    git status >> "$REPORT_FILE" 2>&1
    echo "\`\`\`" >> "$REPORT_FILE"

    # Verificar se existe branch main
    if git show-ref --verify --quiet refs/heads/main 2>/dev/null; then
        log_success "Branch 'main' existe"
        echo "- âœ… Branch 'main' existe" >> "$REPORT_FILE"

        # Comparar main com default/atual
        if [ "$CURRENT_BRANCH" != "main" ]; then
            log_warning "NÃ£o estÃ¡ na branch 'main'"
            echo "- âš ï¸ **NÃ£o estÃ¡ na branch 'main'**" >> "$REPORT_FILE"
        fi
    else
        log_error "Branch 'main' nÃ£o existe"
        echo "- âŒ **Branch 'main' nÃ£o existe**" >> "$REPORT_FILE"
    fi

    log_success "Auditoria Git concluÃ­da"
}

# 2. Auditoria de Dados CSV/SQL
audit_data_files() {
    log_section "ðŸ“Š Auditoria de Arquivos de Dados"

    cd "$PROJECT_DIR"

    cat >> "$REPORT_FILE" << EOF
## ðŸ“Š Auditoria de Arquivos de Dados

EOF

    # Contar arquivos CSV
    CSV_COUNT=$(find . -name "*.csv" -type f | wc -l | tr -d ' ')
    log_info "Arquivos CSV encontrados: $CSV_COUNT"
    echo "- **Arquivos CSV**: $CSV_COUNT" >> "$REPORT_FILE"

    if [ "$CSV_COUNT" -gt 0 ]; then
        echo "" >> "$REPORT_FILE"
        echo "### Lista de Arquivos CSV" >> "$REPORT_FILE"
        echo "\`\`\`" >> "$REPORT_FILE"
        find . -name "*.csv" -type f >> "$REPORT_FILE"
        echo "\`\`\`" >> "$REPORT_FILE"

        # Verificar tamanhos
        echo "" >> "$REPORT_FILE"
        echo "### Tamanhos dos Arquivos CSV" >> "$REPORT_FILE"
        echo "\`\`\`" >> "$REPORT_FILE"
        find . -name "*.csv" -type f -exec ls -lh {} \; | awk '{print $5, $9}' >> "$REPORT_FILE"
        echo "\`\`\`" >> "$REPORT_FILE"
    else
        log_warning "Nenhum arquivo CSV encontrado"
        echo "- âš ï¸ **Nenhum arquivo CSV encontrado**" >> "$REPORT_FILE"
    fi

    # Contar arquivos SQL
    SQL_COUNT=$(find . -name "*.sql" -type f | wc -l | tr -d ' ')
    log_info "Arquivos SQL encontrados: $SQL_COUNT"
    echo "" >> "$REPORT_FILE"
    echo "- **Arquivos SQL**: $SQL_COUNT" >> "$REPORT_FILE"

    if [ "$SQL_COUNT" -gt 0 ]; then
        echo "" >> "$REPORT_FILE"
        echo "### Lista de Arquivos SQL" >> "$REPORT_FILE"
        echo "\`\`\`" >> "$REPORT_FILE"
        find . -name "*.sql" -type f >> "$REPORT_FILE"
        echo "\`\`\`" >> "$REPORT_FILE"
    else
        log_warning "Nenhum arquivo SQL encontrado"
        echo "- âš ï¸ **Nenhum arquivo SQL encontrado**" >> "$REPORT_FILE"
    fi

    # Verificar diretÃ³rio de dados
    DATA_DIR="$PROJECT_DIR/00_ANALISES_E_DADOS"
    if [ -d "$DATA_DIR" ]; then
        log_info "DiretÃ³rio de dados encontrado: $DATA_DIR"
        echo "" >> "$REPORT_FILE"
        echo "### Estrutura do DiretÃ³rio de Dados" >> "$REPORT_FILE"
        echo "\`\`\`" >> "$REPORT_FILE"
        ls -la "$DATA_DIR" >> "$REPORT_FILE" 2>&1
        echo "\`\`\`" >> "$REPORT_FILE"

        # Verificar NOCODB_IMPORT
        if [ -d "$DATA_DIR/NOCODB_IMPORT" ]; then
            log_success "DiretÃ³rio NOCODB_IMPORT encontrado"
            echo "- âœ… DiretÃ³rio NOCODB_IMPORT encontrado" >> "$REPORT_FILE"

            NOCODB_CSV=$(find "$DATA_DIR/NOCODB_IMPORT" -name "*.csv" | wc -l | tr -d ' ')
            echo "- Arquivos CSV em NOCODB_IMPORT: $NOCODB_CSV" >> "$REPORT_FILE"
        else
            log_warning "DiretÃ³rio NOCODB_IMPORT nÃ£o encontrado"
            echo "- âš ï¸ DiretÃ³rio NOCODB_IMPORT nÃ£o encontrado" >> "$REPORT_FILE"
        fi
    fi

    log_success "Auditoria de dados concluÃ­da"
}

# 3. Verificar tipos de dados especÃ­ficos
audit_specific_data_types() {
    log_section "ðŸ“„ VerificaÃ§Ã£o de Tipos de Dados EspecÃ­ficos"

    cd "$PROJECT_DIR"

    cat >> "$REPORT_FILE" << EOF
## ðŸ“„ VerificaÃ§Ã£o de Tipos de Dados EspecÃ­ficos

### Tipos de Documentos Esperados:
- Demonstrativos financeiros
- Dados de contratos
- Recibos
- Extratos bancÃ¡rios
- Notas fiscais

EOF

    # Buscar por palavras-chave nos nomes de arquivos
    KEYWORDS=(
        "demonstrativo"
        "contrato"
        "recibo"
        "extrato"
        "nota_fiscal"
        "nota-fiscal"
        "financeiro"
        "banco"
    )

    for keyword in "${KEYWORDS[@]}"; do
        COUNT=$(find . -iname "*${keyword}*" -type f | wc -l | tr -d ' ')
        if [ "$COUNT" -gt 0 ]; then
            log_info "Encontrados arquivos com '$keyword': $COUNT"
            echo "- âœ… **$keyword**: $COUNT arquivo(s)" >> "$REPORT_FILE"
        else
            log_warning "Nenhum arquivo encontrado com '$keyword'"
            echo "- âš ï¸ **$keyword**: Nenhum arquivo encontrado" >> "$REPORT_FILE"
        fi
    done

    log_success "VerificaÃ§Ã£o de tipos de dados concluÃ­da"
}

# 4. Auditoria n8n
audit_n8n() {
    log_section "ðŸ”„ Auditoria n8n"

    cat >> "$REPORT_FILE" << EOF
## ðŸ”„ Auditoria n8n

EOF

    # Verificar se existe configuraÃ§Ã£o n8n no projeto
    N8N_DIRS=$(find "$PROJECT_DIR" -type d -iname "*n8n*" 2>/dev/null | head -5)

    if [ -n "$N8N_DIRS" ]; then
        log_info "DiretÃ³rios n8n encontrados:"
        echo "$N8N_DIRS" | while read -r dir; do
            echo "- âœ… DiretÃ³rio n8n: \`$dir\`" >> "$REPORT_FILE"
            log_info "  - $dir"
        done
    else
        log_warning "Nenhum diretÃ³rio n8n encontrado no projeto"
        echo "- âš ï¸ **Nenhum diretÃ³rio n8n encontrado no projeto**" >> "$REPORT_FILE"
    fi

    # Verificar workflows n8n
    N8N_WORKFLOWS=$(find "$PROJECT_DIR" -name "*.json" -type f -exec grep -l "n8n" {} \; 2>/dev/null | head -10)

    if [ -n "$N8N_WORKFLOWS" ]; then
        echo "" >> "$REPORT_FILE"
        echo "### Workflows n8n Encontrados" >> "$REPORT_FILE"
        echo "$N8N_WORKFLOWS" | while read -r workflow; do
            echo "- \`$workflow\`" >> "$REPORT_FILE"
        done
    else
        echo "- âš ï¸ **Nenhum workflow n8n encontrado**" >> "$REPORT_FILE"
    fi

    log_success "Auditoria n8n concluÃ­da"
}

# 5. Verificar VPS Ubuntu
audit_vps() {
    log_section "ðŸ–¥ï¸  VerificaÃ§Ã£o VPS Ubuntu"

    cat >> "$REPORT_FILE" << EOF
## ðŸ–¥ï¸ VerificaÃ§Ã£o VPS Ubuntu

**Nota**: Esta auditoria verifica configuraÃ§Ãµes locais relacionadas Ã  VPS.

EOF

    # Verificar configuraÃ§Ã£o de infraestrutura
    INFRA_PROD="$HOME/infra/stack-prod"

    if [ -d "$INFRA_PROD" ]; then
        log_success "DiretÃ³rio de infraestrutura produÃ§Ã£o encontrado"
        echo "- âœ… DiretÃ³rio de infraestrutura produÃ§Ã£o: \`$INFRA_PROD\`" >> "$REPORT_FILE"

        # Verificar docker-compose.yml
        if [ -f "$INFRA_PROD/docker-compose.yml" ]; then
            log_success "docker-compose.yml encontrado"
            echo "- âœ… docker-compose.yml encontrado" >> "$REPORT_FILE"
        fi

        # Verificar scripts
        if [ -d "$INFRA_PROD/scripts" ]; then
            SCRIPT_COUNT=$(find "$INFRA_PROD/scripts" -type f | wc -l | tr -d ' ')
            log_info "Scripts encontrados: $SCRIPT_COUNT"
            echo "- Scripts: $SCRIPT_COUNT" >> "$REPORT_FILE"
        fi
    else
        log_warning "DiretÃ³rio de infraestrutura produÃ§Ã£o nÃ£o encontrado"
        echo "- âš ï¸ **DiretÃ³rio de infraestrutura produÃ§Ã£o nÃ£o encontrado**" >> "$REPORT_FILE"
    fi

    log_success "VerificaÃ§Ã£o VPS concluÃ­da"
}

# 6. Verificar acesso do Claude
audit_claude_access() {
    log_section "ðŸ¤– VerificaÃ§Ã£o de Acesso Claude"

    cat >> "$REPORT_FILE" << EOF
## ðŸ¤– VerificaÃ§Ã£o de Acesso Claude

EOF

    # Verificar se existe .cursorrules
    if [ -f "$PROJECT_DIR/.cursorrules" ]; then
        log_success ".cursorrules encontrado"
        echo "- âœ… .cursorrules encontrado" >> "$REPORT_FILE"
    else
        log_error ".cursorrules nÃ£o encontrado"
        echo "- âŒ **.cursorrules nÃ£o encontrado**" >> "$REPORT_FILE"
    fi

    # Verificar documentaÃ§Ã£o do projeto no Claude Cloud Knowledge
    CLAUDE_KNOWLEDGE="$HOME/Dotfiles/claude-cloud-knowledge/02_PROJETO_BNI"

    if [ -d "$CLAUDE_KNOWLEDGE" ]; then
        log_success "DiretÃ³rio Claude Cloud Knowledge encontrado"
        echo "- âœ… DiretÃ³rio Claude Cloud Knowledge: \`$CLAUDE_KNOWLEDGE\`" >> "$REPORT_FILE"

        # Listar arquivos
        FILE_COUNT=$(find "$CLAUDE_KNOWLEDGE" -type f | wc -l | tr -d ' ')
        echo "- Arquivos de contexto: $FILE_COUNT" >> "$REPORT_FILE"
    else
        log_warning "DiretÃ³rio Claude Cloud Knowledge nÃ£o encontrado"
        echo "- âš ï¸ **DiretÃ³rio Claude Cloud Knowledge nÃ£o encontrado**" >> "$REPORT_FILE"
    fi

    log_success "VerificaÃ§Ã£o Claude concluÃ­da"
}

# FunÃ§Ã£o principal
main() {
    echo -e "${MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${MAGENTA}ðŸ” Auditoria Completa - Projeto BNI${NC}"
    echo -e "${MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    audit_git
    audit_data_files
    audit_specific_data_types
    audit_n8n
    audit_vps
    audit_claude_access

    # Resumo final
    cat >> "$REPORT_FILE" << EOF
---

## ðŸ“‹ Resumo da Auditoria

**Data**: $(date '+%Y-%m-%d %H:%M:%S')
**Projeto**: BNI GestÃ£o de ImÃ³veis
**LocalizaÃ§Ã£o**: $PROJECT_DIR

### RecomendaÃ§Ãµes

1. **Git**: Verificar branch 'main' e garantir acesso do Claude
2. **Dados**: Verificar se todos os tipos de documentos estÃ£o presentes
3. **n8n**: Revisar workflows iniciais
4. **VPS**: Verificar sincronizaÃ§Ã£o de configuraÃ§Ãµes
5. **Claude**: Garantir que contexto estÃ¡ atualizado no Claude Cloud

---

**RelatÃ³rio completo salvo em**: \`$REPORT_FILE\`
EOF

    log_section "âœ… Auditoria ConcluÃ­da"

    echo -e "${GREEN}âœ… RelatÃ³rio completo salvo em:${NC}"
    echo "   $REPORT_FILE"
    echo ""
    echo -e "${BLUE}ðŸ“„ Abrindo relatÃ³rio...${NC}"
    cat "$REPORT_FILE"
}

main "$@"

