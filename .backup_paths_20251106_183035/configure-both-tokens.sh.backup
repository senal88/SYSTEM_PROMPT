#!/usr/bin/env bash
set -euo pipefail

# Script para configurar tokens do 1Password para macOS e VPS
# Resolve problemas de autenticaÃ§Ã£o usando os tokens corretos

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo -e "â•‘              CONFIGURAÃ‡ÃƒO TOKENS MACOS + VPS                    â•‘"
echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# 1. Tokens identificados
log "Configurando tokens identificados..."

# Token macOS
MACOS_TOKEN="eyJhbGciOiJFUzI1NiIsImtpZCI6ImNvNnU1ZGE2M2Jwem9mbjZ6M25kczV5Nm1pIiwidHlwIjoiSldUIn0.eyIxcGFzc3dvcmQuY29tL2F1dWlkIjoiUlRUVzNRWUQ2RkdTQkZUTUVUTTYzSE5OTzQiLCIxcGFzc3dvcmQuY29tL3Rva2VuIjoiQmxVV1preWpuOWFVVVJQSEE5OGh0Rm5aWTA0QkFyMGoiLCIxcGFzc3dvcmQuY29tL2Z0cyI6WyJ2YXVsdGFjY2VzcyJdLCIxcGFzc3dvcmQuY29tL3Z0cyI6W3sidSI6ImdrcHNiZ2l6bGtzMnprbnd6cXBwcG5iMnplIiwiYSI6NDk2fV0sImF1ZCI6WyJjb20uMXBhc3N3b3JkLmNvbm5lY3QiXSwic3ViIjoiVTczR1RSRzJHQkQ2UkRGQVVIQlBBV0NKTlEiLCJpYXQiOjE3NjE0MDg4NjcsImlzcyI6ImNvbS4xcGFzc3dvcmQuYjUiLCJqdGkiOiI0c2ZzNnpveTZudWJ1eHJxaDRiaGE2YjM2NCJ9.o8ZzCONl-qNkYu6HOCZBIfNVMKmEJvv-VaAlRQ8hROjRI0jOBpRUt0WbTba0VriCevMWDiPrywQOwr3eLKzW_g"

# Token VPS
VPS_TOKEN="eyJhbGciOiJFUzI1NiIsImtpZCI6ImZsdXN1N3F1eGtiNHpxZmlkMzd2ZWc3d2N5IiwidHlwIjoiSldUIn0.eyIxcGFzc3dvcmQuY29tL2F1dWlkIjoiUlRUVzNRWUQ2RkdTQkZUTUVUTTYzSE5OTzQiLCIxcGFzc3dvcmQuY29tL3Rva2VuIjoiX0RiLV9PcjJjWGFPbW50NFFRMzhjcVpYMExmWFRsWTciLCIxcGFzc3dvcmQuY29tL2Z0cyI6WyJ2YXVsdGFjY2VzcyJdLCIxcGFzc3dvcmQuY29tL3Z0cyI6W3sidSI6Im9hM3RpZGVrbWV1MjZueGlpZXIycWJpN3Y0IiwiYSI6NDh9XSwiYXVkIjpbImNvbS4xcGFzc3dvcmQuY29ubmVjdCJdLCJzdWIiOiJJUDNWVkVCMkNCSFY1R01YTTVQRkhJQkgzNCIsImlhdCI6MTc2MTU3MDgxNCwiaXNzIjoiY29tLjFwYXNzd29yZC5iNSIsImp0aSI6InB4ZTRhZjRkNWd5aXJ5aWFmbnVkNHd5M21hIn0.JeWuTLjJoshK6qk28l_PqedNXUtFo-R2s5g7OGkaY1S2hHMunXWVC76sUcVEAkY32Ic4SduU6471mv37qUDWUg"

# Vault IDs extraÃ­dos dos tokens
MACOS_VAULT="gkpsbgizlks2zknwzqpppnb2ze"
VPS_VAULT="oa3tidekmeu26nxiiier2qbi7v4"

log "âœ… Token macOS: ${MACOS_TOKEN:0:20}..."
log "âœ… Token VPS: ${VPS_TOKEN:0:20}..."

# 2. Verificar 1Password CLI
log "Verificando 1Password CLI..."
if ! command -v op >/dev/null 2>&1; then
    error "1Password CLI nÃ£o estÃ¡ instalado. Instalando..."
    brew install --cask 1password-cli
fi

# 3. Configurar ambiente macOS
log "Configurando ambiente macOS..."
export OP_CONNECT_TOKEN="$MACOS_TOKEN"
export OP_CONNECT_HOST="http://localhost:8080"
export OP_VAULT="$MACOS_VAULT"

# 4. Verificar se o 1Password Connect Server estÃ¡ rodando
log "Verificando 1Password Connect Server..."
if curl -s "$OP_CONNECT_HOST/health" >/dev/null 2>&1; then
    log "âœ… 1Password Connect Server estÃ¡ rodando"
else
    warn "1Password Connect Server nÃ£o estÃ¡ rodando"
    info "Para iniciar o servidor:"
    echo "  cd /Users/luiz.sena88/Dotfiles/automation_1password/connect"
    echo "  docker-compose up -d"
    echo ""
    read -p "Pressione Enter apÃ³s iniciar o servidor ou Ctrl+C para cancelar..."
fi

# 5. Testar autenticaÃ§Ã£o macOS
log "Testando autenticaÃ§Ã£o macOS..."
if op item list >/dev/null 2>&1; then
    log "âœ… AutenticaÃ§Ã£o macOS bem-sucedida!"
    MACOS_ITEMS=$(op item list --format=json | jq '. | length' 2>/dev/null || echo "0")
    log "âœ… Acesso a $MACOS_ITEMS itens no vault macOS"
else
    error "âŒ Falha na autenticaÃ§Ã£o macOS"
    exit 1
fi

# 6. Configurar ambiente VPS
log "Configurando ambiente VPS..."
export OP_CONNECT_TOKEN_VPS="$VPS_TOKEN"
export OP_CONNECT_HOST_VPS="https://manager.senamfo.com.br:8080"
export OP_VAULT_VPS="$VPS_VAULT"

# 7. Testar autenticaÃ§Ã£o VPS
log "Testando autenticaÃ§Ã£o VPS..."
if OP_CONNECT_TOKEN="$VPS_TOKEN" OP_CONNECT_HOST="$OP_CONNECT_HOST_VPS" op item list >/dev/null 2>&1; then
    log "âœ… AutenticaÃ§Ã£o VPS bem-sucedida!"
    VPS_ITEMS=$(OP_CONNECT_TOKEN="$VPS_TOKEN" OP_CONNECT_HOST="$OP_CONNECT_HOST_VPS" op item list --format=json | jq '. | length' 2>/dev/null || echo "0")
    log "âœ… Acesso a $VPS_ITEMS itens no vault VPS"
else
    warn "âš ï¸  Falha na autenticaÃ§Ã£o VPS (servidor pode nÃ£o estar acessÃ­vel)"
fi

# 8. Salvar configuraÃ§Ãµes no perfil do shell
log "Salvando configuraÃ§Ãµes no perfil do shell..."
SHELL_PROFILE="$HOME/.zprofile"

# Limpar configuraÃ§Ãµes antigas
sed -i '' '/# 1Password Connect Configuration/,/^$/d' "$SHELL_PROFILE" 2>/dev/null || true

# Adicionar novas configuraÃ§Ãµes
cat >> "$SHELL_PROFILE" << 'EOF'

# 1Password Connect Configuration
export OP_CONNECT_TOKEN_MACOS='eyJhbGciOiJFUzI1NiIsImtpZCI6ImNvNnU1ZGE2M2Jwem9mbjZ6M25kczV5Nm1pIiwidHlwIjoiSldUIn0.eyIxcGFzc3dvcmQuY29tL2F1dWlkIjoiUlRUVzNRWUQ2RkdTQkZUTUVUTTYzSE5OTzQiLCIxcGFzc3dvcmQuY29tL3Rva2VuIjoiQmxVV1preWpuOWFVVVJQSEE5OGh0Rm5aWTA0QkFyMGoiLCIxcGFzc3dvcmQuY29tL2Z0cyI6WyJ2YXVsdGFjY2VzcyJdLCIxcGFzc3dvcmQuY29tL3Z0cyI6W3sidSI6ImdrcHNiZ2l6bGtzMnprbnd6cXBwcG5iMnplIiwiYSI6NDk2fV0sImF1ZCI6WyJjb20uMXBhc3N3b3JkLmNvbm5lY3QiXSwic3ViIjoiVTczR1RSRzJHQkQ2UkRGQVVIQlBBV0NKTlEiLCJpYXQiOjE3NjE0MDg4NjcsImlzcyI6ImNvbS4xcGFzc3dvcmQuYjUiLCJqdGkiOiI0c2ZzNnpveTZudWJ1eHJxaDRiaGE2YjM2NCJ9.o8ZzCONl-qNkYu6HOCZBIfNVMKmEJvv-VaAlRQ8hROjRI0jOBpRUt0WbTba0VriCevMWDiPrywQOwr3eLKzW_g'
export OP_CONNECT_TOKEN_VPS='eyJhbGciOiJFUzI1NiIsImtpZCI6ImZsdXN1N3F1eGtiNHpxZmlkMzd2ZWc3d2N5IiwidHlwIjoiSldUIn0.eyIxcGFzc3dvcmQuY29tL2F1dWlkIjoiUlRUVzNRWUQ2RkdTQkZUTUVUTTYzSE5OTzQiLCIxcGFzc3dvcmQuY29tL3Rva2VuIjoiX0RiLV9PcjJjWGFPbW50NFFRMzhjcVpYMExmWFRsWTciLCIxcGFzc3dvcmQuY29tL2Z0cyI6WyJ2YXVsdGFjY2VzcyJdLCIxcGFzc3dvcmQuY29tL3Z0cyI6W3sidSI6Im9hM3RpZGVrbWV1MjZueGlpZXIycWJpN3Y0IiwiYSI6NDh9XSwiYXVkIjpbImNvbS4xcGFzc3dvcmQuY29ubmVjdCJdLCJzdWIiOiJJUDNWVkVCMkNCSFY1R01YTTVQRkhJQkgzNCIsImlhdCI6MTc2MTU3MDgxNCwiaXNzIjoiY29tLjFwYXNzd29yZC5iNSIsImp0aSI6InB4ZTRhZjRkNWd5aXJ5aWFmbnVkNHd5M21hIn0.JeWuTLjJoshK6qk28l_PqedNXUtFo-R2s5g7OGkaY1S2hHMunXWVC76sUcVEAkY32Ic4SduU6471mv37qUDWUg'
export OP_CONNECT_HOST_MACOS='http://localhost:8080'
export OP_CONNECT_HOST_VPS='https://manager.senamfo.com.br:8080'
export OP_VAULT_MACOS='gkpsbgizlks2zknwzqpppnb2ze'
export OP_VAULT_VPS='oa3tidekmeu26nxiiier2qbi7v4'

# ConfiguraÃ§Ã£o padrÃ£o para macOS
export OP_CONNECT_TOKEN="$OP_CONNECT_TOKEN_MACOS"
export OP_CONNECT_HOST="$OP_CONNECT_HOST_MACOS"
export OP_VAULT="$OP_VAULT_MACOS"
EOF

log "âœ… ConfiguraÃ§Ãµes salvas em $SHELL_PROFILE"

# 9. Criar scripts de comutaÃ§Ã£o
log "Criando scripts de comutaÃ§Ã£o..."

# Script para usar ambiente macOS
cat > "$PWD/use-macos-env.sh" << 'BASH'
#!/bin/bash
# Script para usar ambiente macOS
export OP_CONNECT_TOKEN="$OP_CONNECT_TOKEN_MACOS"
export OP_CONNECT_HOST="$OP_CONNECT_HOST_MACOS"
export OP_VAULT="$OP_VAULT_MACOS"
echo "ğŸ”§ Ambiente configurado para macOS"
echo "Host: $OP_CONNECT_HOST"
echo "Vault: $OP_VAULT"
BASH

# Script para usar ambiente VPS
cat > "$PWD/use-vps-env.sh" << 'BASH'
#!/bin/bash
# Script para usar ambiente VPS
export OP_CONNECT_TOKEN="$OP_CONNECT_TOKEN_VPS"
export OP_CONNECT_HOST="$OP_CONNECT_HOST_VPS"
export OP_VAULT="$OP_VAULT_VPS"
echo "ğŸ”§ Ambiente configurado para VPS"
echo "Host: $OP_CONNECT_HOST"
echo "Vault: $OP_VAULT"
BASH

chmod +x "$PWD/use-macos-env.sh" "$PWD/use-vps-env.sh"

# 10. Criar script de teste completo
log "Criando script de teste completo..."
cat > "$PWD/test-both-environments.sh" << 'BASH'
#!/bin/bash
# Script para testar ambos os ambientes

echo "ğŸ” Testando ambientes 1Password..."

# Carregar configuraÃ§Ãµes
source ~/.zprofile

echo ""
echo "1. Testando ambiente macOS..."
export OP_CONNECT_TOKEN="$OP_CONNECT_TOKEN_MACOS"
export OP_CONNECT_HOST="$OP_CONNECT_HOST_MACOS"
export OP_VAULT="$OP_VAULT_MACOS"

if op item list >/dev/null 2>&1; then
    ITEM_COUNT=$(op item list --format=json | jq '. | length' 2>/dev/null || echo "0")
    echo "âœ… macOS: $ITEM_COUNT itens acessÃ­veis"
else
    echo "âŒ macOS: Falha na autenticaÃ§Ã£o"
fi

echo ""
echo "2. Testando ambiente VPS..."
export OP_CONNECT_TOKEN="$OP_CONNECT_TOKEN_VPS"
export OP_CONNECT_HOST="$OP_CONNECT_HOST_VPS"
export OP_VAULT="$OP_VAULT_VPS"

if op item list >/dev/null 2>&1; then
    ITEM_COUNT=$(op item list --format=json | jq '. | length' 2>/dev/null || echo "0")
    echo "âœ… VPS: $ITEM_COUNT itens acessÃ­veis"
else
    echo "âŒ VPS: Falha na autenticaÃ§Ã£o (servidor pode nÃ£o estar acessÃ­vel)"
fi

echo ""
echo "ğŸ‰ Teste concluÃ­do!"
BASH

chmod +x "$PWD/test-both-environments.sh"

# 11. Resumo final
echo ""
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo -e "â•‘                CONFIGURAÃ‡ÃƒO CONCLUÃDA!                        â•‘"
echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

info "Tokens configurados:"
echo "âœ… macOS: ${MACOS_TOKEN:0:20}... (Vault: $MACOS_VAULT)"
echo "âœ… VPS: ${VPS_TOKEN:0:20}... (Vault: $VPS_VAULT)"

echo ""
info "Scripts criados:"
echo "âœ… use-macos-env.sh - Configurar ambiente macOS"
echo "âœ… use-vps-env.sh - Configurar ambiente VPS"
echo "âœ… test-both-environments.sh - Testar ambos os ambientes"

echo ""
info "Para usar:"
echo "1. Ambiente macOS (padrÃ£o): op item list"
echo "2. Ambiente VPS: source use-vps-env.sh && op item list"
echo "3. Testar ambos: ./test-both-environments.sh"

echo ""
warn "Importante:"
echo "- Reinicie o terminal ou execute: source ~/.zprofile"
echo "- Para VPS, certifique-se de que o servidor estÃ¡ acessÃ­vel"
echo "- Use os scripts de comutaÃ§Ã£o para alternar entre ambientes"

echo ""
log "ConfiguraÃ§Ã£o completa! Ambos os tokens estÃ£o funcionando! ğŸ¯"
