#!/bin/bash
# Setup GitHub CLI com 1Password
# Configura GitHub CLI e Git com autentica√ß√£o via 1Password

set -euo pipefail

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}‚Ñπ${NC} $1"
}

log_success() {
    echo -e "${GREEN}‚úì${NC} $1"
}

log_error() {
    echo -e "${RED}‚úó${NC} $1" >&2
}

log_warning() {
    echo -e "${YELLOW}‚ö†${NC} $1"
}

# Verificar se 1Password est√° configurado
if ! op whoami &>/dev/null; then
    log_error "1Password n√£o est√° logado. Execute: op-signin-auto"
    exit 1
fi

log_info "üöÄ Configurando GitHub CLI e Git..."

# Determinar vault padr√£o
if [[ "$(hostname)" == *"MacBook"* ]] || [[ "$OSTYPE" == "darwin"* ]]; then
    VAULT="1p_macos"
    VAULT_ID="gkpsbgizlks2zknwzqpppnb2ze"
else
    VAULT="1p_vps"
    VAULT_ID="oa3tidekmeu26nxiier2qbi7v4"
fi

# 1. Verificar se GitHub Token existe no 1Password
log_info "Verificando token do GitHub no 1Password..."
if ! op item get "GitHub Token" --vault "$VAULT" &>/dev/null; then
    log_warning "Token do GitHub n√£o encontrado no vault $VAULT"
    log_info "Criando item no 1Password..."

    read -p "Digite o token do GitHub (ou pressione Enter para pular): " GITHUB_TOKEN

    if [ -n "$GITHUB_TOKEN" ]; then
        op item create \
            --category=password \
            --title="GitHub Token" \
            --vault="$VAULT" \
            --field="username=luiz.sena88" \
            --field="password=$GITHUB_TOKEN" \
            --field="url=https://github.com/settings/tokens" \
            --field="notes=Token de acesso pessoal do GitHub"

        log_success "Token do GitHub criado no 1Password"
    else
        log_warning "Pulando cria√ß√£o do token. Configure manualmente depois."
    fi
fi

# 2. Obter token e fazer login no GitHub CLI
if command -v gh &>/dev/null; then
    log_info "Fazendo login no GitHub CLI..."

    if op item get "GitHub Token" --vault "$VAULT" &>/dev/null; then
        GITHUB_TOKEN=$(op item get "GitHub Token" --vault "$VAULT" --field password)

        echo "$GITHUB_TOKEN" | gh auth login --with-token

        if gh auth status &>/dev/null; then
            log_success "GitHub CLI autenticado"
            gh auth status
        else
            log_error "Erro ao autenticar no GitHub CLI"
            exit 1
        fi
    else
        log_warning "Token n√£o encontrado. Execute login manual: gh auth login"
    fi
else
    log_warning "GitHub CLI (gh) n√£o instalado. Instale via Homebrew: brew install gh"
fi

# 3. Configurar Git
log_info "Configurando Git..."

# Verificar se j√° est√° configurado
if ! git config --global user.name &>/dev/null; then
    git config --global user.name "Luiz Sena"
    log_success "Git user.name configurado"
else
    log_info "Git user.name j√° configurado: $(git config --global user.name)"
fi

if ! git config --global user.email &>/dev/null; then
    git config --global user.email "luiz.sena88@icloud.com"
    log_success "Git user.email configurado"
else
    log_info "Git user.email j√° configurado: $(git config --global user.email)"
fi

git config --global init.defaultBranch main
log_success "Git branch padr√£o configurado: main"

# 4. Configurar SSH para GitHub (se chave existir)
log_info "Verificando chaves SSH para GitHub..."

if op item get "GitHub SSH Key" --vault "$VAULT" &>/dev/null; then
    log_info "Chave SSH encontrada no 1Password..."

    SSH_KEY_DIR="$HOME/.ssh"
    SSH_KEY_FILE="$SSH_KEY_DIR/id_ed25519_github"

    mkdir -p "$SSH_KEY_DIR"

    # Obter chave privada
    op item get "GitHub SSH Key" --vault "$VAULT" --field "private_key" > "$SSH_KEY_FILE"
    chmod 600 "$SSH_KEY_FILE"

    # Obter chave p√∫blica (se existir)
    if op item get "GitHub SSH Key" --vault "$VAULT" --field "public_key" &>/dev/null; then
        op item get "GitHub SSH Key" --vault "$VAULT" --field "public_key" > "${SSH_KEY_FILE}.pub"
        chmod 644 "${SSH_KEY_FILE}.pub"
    fi

    # Adicionar ao SSH config
    if [ -f "$SSH_KEY_FILE" ]; then
        if ! grep -q "Host github.com" "$SSH_KEY_DIR/config" 2>/dev/null; then
            cat >> "$SSH_KEY_DIR/config" << EOF

# GitHub
Host github.com
    HostName github.com
    User git
    IdentityFile $SSH_KEY_FILE
    IdentitiesOnly yes
EOF
            chmod 600 "$SSH_KEY_DIR/config"
            log_success "SSH config atualizado para GitHub"
        else
            log_info "SSH config j√° cont√©m GitHub"
        fi
    fi
else
    log_warning "Chave SSH n√£o encontrada no 1Password"
    log_info "Para adicionar: op item create --category=ssh_key --title='GitHub SSH Key' --vault=$VAULT"
fi

# 5. Configurar dotfiles no GitHub (se aplic√°vel)
log_info "Verificando reposit√≥rio dotfiles..."

DOTFILES_DIR="$HOME/Dotfiles"
if [ -d "$DOTFILES_DIR/.git" ]; then
    log_info "Reposit√≥rio Git encontrado em $DOTFILES_DIR"

    # Verificar remote
    if ! git -C "$DOTFILES_DIR" remote get-url origin &>/dev/null; then
        read -p "URL do reposit√≥rio GitHub para dotfiles (ou Enter para pular): " REPO_URL

        if [ -n "$REPO_URL" ]; then
            git -C "$DOTFILES_DIR" remote add origin "$REPO_URL"
            log_success "Remote origin configurado"
        fi
    else
        log_info "Remote origin j√° configurado: $(git -C "$DOTFILES_DIR" remote get-url origin)"
    fi
else
    log_info "Diret√≥rio dotfiles n√£o √© um reposit√≥rio Git"
fi

# 6. Configurar Codespaces (se no macOS)
if [[ "$OSTYPE" == "darwin"* ]]; then
    log_info "Configura√ß√µes para Codespaces dispon√≠veis via .devcontainer/"
fi

log_success "‚úÖ Setup do GitHub conclu√≠do!"
log_info ""
log_info "Pr√≥ximos passos:"
log_info "1. Teste: gh auth status"
log_info "2. Teste: gh repo list"
log_info "3. Teste SSH: ssh -T git@github.com"

