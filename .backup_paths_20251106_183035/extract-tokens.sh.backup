#!/usr/bin/env bash
set -euo pipefail

# Script para extrair e organizar tokens identificados
# Identifica tokens de VPS e macOS Silicon

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo -e "â•‘                    IDENTIFICAÃ‡ÃƒO DE TOKENS                      â•‘"
echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# 1. Token do 1Password Connect para macOS
log "Identificando token do 1Password Connect para macOS..."
MACOS_TOKEN_FILE="/Users/luiz.sena88/Dotfiles/automation_1password/connect/macos_connect_server/macos_conect_server.txt"

if [[ -f "$MACOS_TOKEN_FILE" ]]; then
    MACOS_TOKEN=$(cat "$MACOS_TOKEN_FILE" | tr -d '\n' | tr -d ' ')
    log "âœ… Token macOS encontrado: ${MACOS_TOKEN:0:20}..."
    
    # Decodificar JWT para verificar informaÃ§Ãµes
    if command -v jq >/dev/null 2>&1; then
        # Extrair payload do JWT
        PAYLOAD=$(echo "$MACOS_TOKEN" | cut -d'.' -f2)
        # Adicionar padding se necessÃ¡rio
        PADDING=$((4 - (${#PAYLOAD} % 4)))
        if [[ $PADDING -ne 4 ]]; then
            PAYLOAD="${PAYLOAD}$(printf '%*s' $PADDING | tr ' ' '=')"
        fi
        # Decodificar base64
        DECODED=$(echo "$PAYLOAD" | base64 -d 2>/dev/null || echo "{}")
        if [[ "$DECODED" != "{}" ]]; then
            info "InformaÃ§Ãµes do token macOS:"
            echo "$DECODED" | jq -r '{
                "audience": .aud[0],
                "subject": .sub,
                "issued_at": .iat,
                "expires_at": .exp,
                "vault_access": ."1password.com/vts"
            }' 2>/dev/null || echo "Token vÃ¡lido mas nÃ£o decodificÃ¡vel"
        fi
    fi
else
    warn "Arquivo de token macOS nÃ£o encontrado: $MACOS_TOKEN_FILE"
fi

echo ""

# 2. Verificar configuraÃ§Ãµes do VPS
log "Identificando configuraÃ§Ãµes do VPS..."
VPS_ENV_FILE="/Users/luiz.sena88/Dotfiles/automation_1password/env/vps.env"

if [[ -f "$VPS_ENV_FILE" ]]; then
    log "âœ… Arquivo de configuraÃ§Ã£o VPS encontrado"
    
    # Extrair informaÃ§Ãµes do VPS
    VPS_IP=$(grep -o '147\.79\.81\.59' "$VPS_ENV_FILE" || echo "NÃ£o encontrado")
    VPS_DOMAIN=$(grep -o 'senamfo\.com\.br' "$VPS_ENV_FILE" || echo "NÃ£o encontrado")
    
    info "ConfiguraÃ§Ãµes do VPS identificadas:"
    echo "  - IP: $VPS_IP"
    echo "  - DomÃ­nio: $VPS_DOMAIN"
    echo "  - Ambiente: production"
    echo "  - RegiÃ£o: us-central1"
else
    warn "Arquivo de configuraÃ§Ã£o VPS nÃ£o encontrado: $VPS_ENV_FILE"
fi

echo ""

# 3. Verificar DNS records do VPS
log "Analisando registros DNS do VPS..."
DNS_FILE="/Users/luiz.sena88/Dotfiles/automation_1password/configs/vps_registros_dns_cloudflare.txt"

if [[ -f "$DNS_FILE" ]]; then
    log "âœ… Registros DNS encontrados"
    
    # Contar serviÃ§os configurados
    SERVICE_COUNT=$(grep -c "CNAME.*manager.senamfo.com.br" "$DNS_FILE" || echo "0")
    PROXIED_COUNT=$(grep -c "cf-proxied:true" "$DNS_FILE" || echo "0")
    UNPROXIED_COUNT=$(grep -c "cf-proxied:false" "$DNS_FILE" || echo "0")
    
    info "ServiÃ§os configurados no VPS:"
    echo "  - Total de serviÃ§os: $SERVICE_COUNT"
    echo "  - Com proxy Cloudflare: $PROXIED_COUNT"
    echo "  - Sem proxy Cloudflare: $UNPROXIED_COUNT"
    
    # Listar alguns serviÃ§os principais
    info "ServiÃ§os principais identificados:"
    grep "CNAME.*manager.senamfo.com.br" "$DNS_FILE" | head -10 | while read line; do
        service=$(echo "$line" | awk '{print $1}' | sed 's/\.senamfo\.com\.br\.//')
        echo "  - $service"
    done
else
    warn "Arquivo de DNS nÃ£o encontrado: $DNS_FILE"
fi

echo ""

# 4. Verificar tokens de API
log "Identificando tokens de API..."
API_TOKENS=()

# Verificar se hÃ¡ tokens do OpenAI
if grep -q "openai-domain-verification" "$DNS_FILE" 2>/dev/null; then
    OPENAI_VERIFICATION=$(grep "openai-domain-verification" "$DNS_FILE" | grep -o 'dv-[A-Za-z0-9_-]*' || echo "")
    if [[ -n "$OPENAI_VERIFICATION" ]]; then
        API_TOKENS+=("OpenAI Domain Verification: $OPENAI_VERIFICATION")
    fi
fi

# Verificar se hÃ¡ tokens do Google
if grep -q "google" "$DNS_FILE" 2>/dev/null; then
    API_TOKENS+=("Google Workspace: Configurado")
fi

# Verificar se hÃ¡ tokens do Cloudflare
if grep -q "cloudflare" "$DNS_FILE" 2>/dev/null; then
    API_TOKENS+=("Cloudflare: Configurado")
fi

if [[ ${#API_TOKENS[@]} -gt 0 ]]; then
    info "Tokens de API identificados:"
    for token in "${API_TOKENS[@]}"; do
        echo "  - $token"
    done
else
    warn "Nenhum token de API identificado nos arquivos de configuraÃ§Ã£o"
fi

echo ""

# 5. Criar arquivo de resumo
log "Criando arquivo de resumo dos tokens..."
SUMMARY_FILE="$PWD/tokens-summary.json"

cat > "$SUMMARY_FILE" << JSON
{
  "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "environment": "macOS Silicon + VPS",
  "tokens": {
    "macos": {
      "1password_connect": {
        "token": "${MACOS_TOKEN:-N/A}",
        "type": "JWT",
        "purpose": "1Password Connect Server",
        "environment": "macOS Development"
      }
    },
    "vps": {
      "ip": "147.79.81.59",
      "domain": "senamfo.com.br",
      "environment": "production",
      "region": "us-central1",
      "services_count": ${SERVICE_COUNT:-0},
      "cloudflare_proxied": ${PROXIED_COUNT:-0},
      "cloudflare_unproxied": ${UNPROXIED_COUNT:-0}
    },
    "apis": {
      "openai": {
        "domain_verification": "${OPENAI_VERIFICATION:-N/A}",
        "status": "configured"
      },
      "google": {
        "status": "configured",
        "mx_records": "active"
      },
      "cloudflare": {
        "status": "configured",
        "dns_management": "active"
      }
    }
  },
  "recommendations": [
    "Configurar 1Password CLI com token macOS",
    "Sincronizar tokens entre ambientes",
    "Implementar rotaÃ§Ã£o automÃ¡tica de tokens",
    "Configurar monitoramento de expiraÃ§Ã£o"
  ]
}
JSON

log "âœ… Resumo salvo em: $SUMMARY_FILE"

echo ""
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo -e "â•‘                    RESUMO DA IDENTIFICAÃ‡ÃƒO                      â•‘"
echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

info "Tokens identificados:"
echo "âœ… 1Password Connect Token (macOS): ${MACOS_TOKEN:0:20}..."
echo "âœ… VPS IP: 147.79.81.59"
echo "âœ… DomÃ­nio: senamfo.com.br"
echo "âœ… ServiÃ§os configurados: $SERVICE_COUNT"
echo "âœ… APIs configuradas: OpenAI, Google, Cloudflare"

echo ""
info "PrÃ³ximos passos recomendados:"
echo "1. Configurar 1Password CLI com o token identificado"
echo "2. Sincronizar configuraÃ§Ãµes entre macOS e VPS"
echo "3. Implementar monitoramento de expiraÃ§Ã£o de tokens"
echo "4. Configurar backup automÃ¡tico das configuraÃ§Ãµes"

echo ""
log "IdentificaÃ§Ã£o de tokens concluÃ­da! ðŸŽ¯"
