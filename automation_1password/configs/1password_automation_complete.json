Text file: 1password_automation_complete.json
Latest content with line numbers:
288	      "setup": [
289	        "# Adicionar Service Account token aos Secrets",
290	        "# Settings > Secrets > Actions > New repository secret",
291	        "# Name: OP_SERVICE_ACCOUNT_TOKEN",
292	        "# Value: ops_<token>"
293	      ],
294	      "workflow_exemplo": "name: Deploy with 1Password Secrets\n\non:\n  push:\n    branches: [main]\n\njobs:\n  deploy:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v3\n\n      - name: Install 1Password CLI\n        uses: 1password/install-cli-action@v1\n\n      - name: Load secrets from 1Password\n        env:\n          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}\n        run: |\n          # Export secrets como env vars\n          export AWS_ACCESS_KEY_ID=$(op item get \"AWS Credentials\" --vault=\"CI/CD\" --fields access_key_id)\n          export AWS_SECRET_ACCESS_KEY=$(op item get \"AWS Credentials\" --vault=\"CI/CD\" --fields secret_access_key)\n\n          # Ou usar secret references\n          op run --env-file=\".env.op\" -- npm run deploy\n\n      - name: Deploy to production\n        run: |\n          # Secrets já disponíveis como env vars\n          ./deploy.sh"
295	    },
296	    "gitlab_ci": {
297	      "variables": [
298	        "# GitLab CI/CD > Settings > CI/CD > Variables",
299	        "# Variable: OP_SERVICE_ACCOUNT_TOKEN",
300	        "# Type: Masked, Protected"
301	      ],
302	      "gitlab_ci_yml": "stages:\n  - deploy\n\ndeploy_prod:\n  stage: deploy\n  image: 1password/op:2\n  variables:\n    OP_SERVICE_ACCOUNT_TOKEN: $OP_SERVICE_ACCOUNT_TOKEN\n  script:\n    - op vault list\n    - export DB_PASSWORD=$(op item get \"Database Prod\" --vault=\"Infra Prod\" --fields password)\n    - ./deploy.sh\n  only:\n    - main"
303	    },
304	    "jenkins": {
305	      "credentials": [
306	        "# Jenkins > Manage Jenkins > Credentials",
307	        "# Add Credentials > Secret text",
308	        "# ID: op-service-account-token"
309	      ],
310	      "jenkinsfile": "pipeline {\n    agent any\n\n    environment {\n        OP_SERVICE_ACCOUNT_TOKEN = credentials('op-service-account-token')\n    }\n\n    stages {\n        stage('Load Secrets') {\n            steps {\n                sh '''\n                    curl -sSO https://downloads.1password.com/linux/debian/amd64/stable/1password-cli-latest-amd64.deb\n                    sudo dpkg -i 1password-cli-latest-amd64.deb\n\n                    export DB_PASSWORD=$(op item get \"Database Prod\" --vault=\"Infra Prod\" --fields password)\n                    echo \"Secret loaded successfully\"\n                '''\n            }\n        }\n\n        stage('Deploy') {\n            steps {\n                sh './deploy.sh'\n            }\n        }\n    }\n}"
311	    }
312	  },
313	  "6_integracao_kubernetes": {
314	    "onepassword_operator": {
315	      "descricao": "Sincroniza automaticamente secrets do 1Password para K8s",
316	      "instalacao": "Já incluído se instalou Connect via Helm com --set operator.create=true",
317	      "uso_basico": {
318	        "criar_secret_no_1password": "Item no vault com campos username, password, hostname",
319	        "criar_onepassworditem_crd": "apiVersion: onepassword.com/v1\nkind: OnePasswordItem\nmetadata:\n  name: database-credentials\n  namespace: production\nspec:\n  itemPath: \"vaults/Infra Prod/items/Database Production\"",
320	        "usar_secret_no_pod": "apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: app\n  namespace: production\nspec:\n  template:\n    spec:\n      containers:\n      - name: app\n        image: myapp:latest\n        env:\n        - name: DB_USERNAME\n          valueFrom:\n            secretKeyRef:\n              name: database-credentials\n              key: username\n        - name: DB_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: database-credentials\n              key: password"
321	      },
322	      "auto_restart_on_update": {
323	        "descricao": "Operator detecta mudanças e restart pods automaticamente",
324	        "annotation": "metadata:\n  annotations:\n    operator.1password.io/auto-restart: \"true\""
325	      }
326	    },
327	    "external_secrets_operator": {
328	      "descricao": "Alternativa ao 1Password Operator, mais flexível",
329	      "setup": [
330	        "# Install External Secrets Operator",
331	        "helm repo add external-secrets https://charts.external-secrets.io",
332	        "helm install external-secrets external-secrets/external-secrets -n external-secrets --create-namespace",
333	        "",
334	        "# Criar SecretStore",
335	        "kubectl apply -f secret-store.yaml"
336	      ],
337	      "secret_store_yaml": "apiVersion: external-secrets.io/v1beta1\nkind: SecretStore\nmetadata:\n  name: onepassword-store\n  namespace: production\nspec:\n  provider:\n    onepassword:\n      connectHost: http://connect-api.1password.svc.cluster.local:8080\n      vaults:\n        Infra Prod: 1\n      auth:\n        secretRef:\n          connectToken:\n            name: op-credentials\n            key: token",
338	      "external_secret_yaml": "apiVersion: external-secrets.io/v1beta1\nkind: ExternalSecret\nmetadata:\n  name: database-secret\n  namespace: production\nspec:\n  refreshInterval: 1h\n  secretStoreRef:\n    name: onepassword-store\n    kind: SecretStore\n  target:\n    name: database-credentials\n    creationPolicy: Owner\n  data:\n  - secretKey: username\n    remoteRef:\n      key: Database Production\n      property: username\n  - secretKey: password\n    remoteRef:\n      key: Database Production\n      property: password"
339	    }
340	  },
341	  "7_secret_references": {
342	    "descricao": "Substituir secrets em runtime sem hardcode",
343	    "formato": "op://<vault>/<item>[/<section>]/<field>",
344	    "uso_env_vars": {
345	      "dot_env_file": "# .env.op\nDATABASE_URL=op://Infra Prod/Database Production/connection_string\nAPI_KEY=op://CI/CD/External API/api_key\nAWS_ACCESS_KEY_ID=op://Infra Prod/AWS Credentials/access_key_id",
346	      "carregar_secrets": [
347	        "# Injetar secrets no ambiente",
348	        "op run --env-file=.env.op -- npm start",
349	        "",
350	        "# Ou export direto",
351	        "op run --env-file=.env.op -- env"
352	      ]
353	    },
354	    "uso_config_files": {
355	      "config_template": "# config.yaml.op\ndatabase:\n  host: op://Infra Prod/Database Production/hostname\n  port: op://Infra Prod/Database Production/port\n  username: op://Infra Prod/Database Production/username\n  password: op://Infra Prod/Database Production/password\n\napi:\n  key: op://CI/CD/External API/api_key\n  endpoint: https://api.example.com",
356	      "injetar_secrets": [
357	        "# Gerar config.yaml com secrets",
358	        "op inject -i config.yaml.op -o config.yaml",
359	        "",
360	        "# Ou usar direto",
361	        "cat config.yaml.op | op inject | kubectl apply -f -"
362	      ]
363	    }
364	  },
365	  "8_sdks_programaticos": {
366	    "python": {
367	      "instalacao": "pip install onepassword-sdk",
368	      "exemplo": "from onepassword import Client, OP_CONNECT_HOST, OP_CONNECT_TOKEN\nimport os\n\n# Configurar client\nclient = Client(\n    url=os.environ.get('OP_CONNECT_HOST'),\n    token=os.environ.get('OP_CONNECT_TOKEN')\n)\n\n# Buscar secret\nitem = client.items.get('Database Production', vault='Infra Prod')\npassword = item.fields['password'].value\n\n# Listar vaults\nvaults = client.vaults.list()\nfor vault in vaults:\n    print(f\"Vault: {vault.name}\")\n\n# Criar item\nnew_item = client.items.create(\n    vault='CI/CD',\n    title='New API Token',\n    category='password',\n    fields=[\n        {'label': 'token', 'value': 'abc123xyz'}\n    ]\n)"
369	    },
370	    "go": {
371	      "instalacao": "go get github.com/1Password/connect-sdk-go",
372	      "exemplo": "package main\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"os\"\n\n    \"github.com/1Password/connect-sdk-go/connect\"\n    \"github.com/1Password/connect-sdk-go/onepassword\"\n)\n\nfunc main() {\n    client := connect.NewClient(\n        os.Getenv(\"OP_CONNECT_HOST\"),\n        os.Getenv(\"OP_CONNECT_TOKEN\"),\n    )\n\n    // Get item\n    item, err := client.GetItem(\"Database Production\", \"Infra Prod\")\n    if err != nil {\n        panic(err)\n    }\n\n    password := item.Fields[0].Value\n    fmt.Printf(\"Password: %s\\n\", password)\n\n    // List vaults\n    vaults, err := client.GetVaults()\n    if err != nil {\n        panic(err)\n    }\n\n    for _, vault := range vaults {\n        fmt.Printf(\"Vault: %s\\n\", vault.Name)\n    }\n}"
373	    },
374	    "javascript": {
375	      "instalacao": "npm install @1password/connect",
376	      "exemplo": "import { OnePasswordConnect } from '@1password/connect';\n\nconst op = OnePasswordConnect({\n  serverURL: process.env.OP_CONNECT_HOST,\n  token: process.env.OP_CONNECT_TOKEN,\n  keepAlive: true\n});\n\n// Get secret\nconst item = await op.getItem('Database Production', 'Infra Prod');\nconst password = item.fields.find(f => f.label === 'password').value;\n\n// List vaults\nconst vaults = await op.listVaults();\nvaults.forEach(vault => {\n  console.log(`Vault: ${vault.name}`);\n});\n\n// Create item\nconst newItem = await op.createItem('CI/CD', {\n  title: 'New API Token',\n  category: 'password',\n  fields: [\n    { label: 'token', value: 'abc123xyz' }\n  ]\n});"
377	    }
378	  },
379	  "9_best_practices_seguranca": {
380	    "least_privilege": [
381	      "✓ 1 token por aplicação/serviço",
382	      "✓ Acesso apenas aos vaults necessários",
383	      "✓ Service Accounts em vez de contas pessoais",
384	      "✓ Revogar tokens não utilizados"
385	    ],
386	    "rotacao_secrets": [
387	      "✓ Rotação automática via scripts",
388	      "✓ Monitorar idade dos secrets",
389	      "✓ Alertar quando expiração próxima",
390	      "✓ Documentar procedimentos de emergência"
391	    ],
392	    "auditoria": [
393	      "✓ Ativar Events API para logs",
394	      "✓ Monitorar acesso aos secrets",
395	      "✓ Alertas para padrões suspeitos",
396	      "✓ Revisão periódica de permissões"
397	    ],
398	    "armazenamento_tokens": [
399	      "✗ NUNCA hardcode tokens em código",
400	      "✗ NUNCA commit tokens no Git",
401	      "✓ Armazenar tokens em 1Password",
402	      "✓ Usar env vars em runtime",
403	      "✓ Tokens de curta duração para CI/CD"
404	    ]
405	  },
406	  "10_troubleshooting": {
407	    "connect_server_nao_responde": [
408	      "# Verificar logs",
409	      "docker logs connect-api",
410	      "docker logs connect-sync",
411	      "",
412	      "# Testar conectividade",
413	      "curl http://localhost:8080/v1/health",
414	      "",
415	      "# Validar credentials",
416	      "cat 1password-credentials.json | jq"
417	    ],
418	    "cli_nao_autentica": [
419	      "# Verificar sessão",
420	      "op whoami",
421	      "",
422	      "# Re-signin",
423	      "eval $(op signin)",
424	      "",
425	      "# Verificar env vars",
426	      "echo $OP_SERVICE_ACCOUNT_TOKEN",
427	      "echo $OP_CONNECT_HOST",
428	      "echo $OP_CONNECT_TOKEN"
429	    ],
430	    "kubernetes_secrets_nao_sincronizam": [
431	      "# Verificar Operator logs",
432	      "kubectl logs -n 1password -l app=connect-operator",
433	      "",
434	      "# Verificar OnePasswordItem status",
435	      "kubectl describe onepassworditem database-credentials -n production",
436	      "",
437	      "# Validar itemPath",
438	      "# Format: vaults/<VAULT_NAME>/items/<ITEM_NAME>"
439	    ]
440	  }
441	}