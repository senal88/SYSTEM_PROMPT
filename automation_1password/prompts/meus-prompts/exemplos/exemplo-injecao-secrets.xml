<?xml version="1.0" encoding="UTF-8"?>
<!--
  Exemplo de Tarefa: Inje√ß√£o de Secrets via 1Password CLI
  Demonstra o processo seguro de inje√ß√£o de secrets
-->

<exemplo_tarefa>
    <descricao>
        Injetar secrets do 1Password no ambiente macOS antes de subir cont√™ineres Docker.
    </descricao>
    
    <entrada>
        <ambiente>macOS Silicon (Desenvolvimento)</ambiente>
        <cofre>1p_macos</cofre>
        <script>~/Dotfiles/automation_1password/scripts/secrets/inject_secrets_macos.sh</script>
    </entrada>
    
    <processo>
        <passo ordem="1">
            <acao>Verificar autentica√ß√£o 1Password CLI</acao>
            <comando>op whoami</comando>
            <validacao>Deve retornar email do usu√°rio autenticado</validacao>
        </passo>
        
        <passo ordem="2">
            <acao>Confirmar cofre acess√≠vel</acao>
            <comando>op vault list | grep -q "1p_macos"</comando>
            <esperado>Exit code 0 (cofre encontrado)</esperado>
        </passo>
        
        <passo ordem="3">
            <acao>Executar script de inje√ß√£o</acao>
            <comando>bash ~/Dotfiles/automation_1password/scripts/secrets/inject_secrets_macos.sh</comando>
            <validacao>Script deve executar sem erros</validacao>
        </passo>
        
        <passo ordem="4">
            <acao>Validar arquivo gerado</acao>
            <comando>ls -la ~/.env.1p</comando>
            <esperado>
                - Arquivo existe
                - Permiss√µes: -rw------- (0600)
                - Propriet√°rio: usu√°rio atual
            </esperado>
        </passo>
        
        <passo ordem="5">
            <acao>Contar vari√°veis injetadas</acao>
            <comando>grep -c "^[A-Z_]*=" ~/.env.1p</comando>
            <esperado>33 vari√°veis (sem expor valores)</esperado>
        </passo>
        
        <passo ordem="6">
            <acao>Validar que nenhum valor foi exposto</acao>
            <comando>grep -E "(ANTHROPIC_API_KEY|OPENAI_API_KEY|GIT_TOKEN)=[^\s]+" ~/.env.1p || echo "‚úÖ Seguro: Apenas nomes de vari√°veis"</comando>
            <esperado>Nenhum valor exposto, apenas nomes</esperado>
        </passo>
    </processo>
    
    <saida_esperada>
        {
            "autenticado": true,
            "cofre_acessivel": true,
            "arquivo_gerado": "~/.env.1p",
            "numero_variaveis": 33,
            "permissoes": "0600",
            "secrets_expostos": 0,
            "status": "sucesso"
        }
    </saida_esperada>
    
    <notas_seguranca>
        <nota>
            ‚ö†Ô∏è NUNCA logar ou exibir valores das vari√°veis de ambiente.
            Sempre mostrar apenas os nomes das vari√°veis ou contagem.
        </nota>
        <nota>
            ‚úÖ Validar permiss√µes do arquivo √© cr√≠tico - deve ser 0600 (read/write apenas propriet√°rio).
        </nota>
        <nota>
            üîí O arquivo .env.1p √© tempor√°rio e deve ser limpo ap√≥s uso (apenas durante sess√£o ativa).
        </nota>
    </notas_seguranca>
</exemplo_tarefa>

