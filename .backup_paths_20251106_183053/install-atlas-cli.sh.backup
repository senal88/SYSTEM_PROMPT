#!/bin/bash
################################################################################
# ATLAS CLI - INSTALADOR E CONFIGURADOR COMPLETO
# Instala e configura o Atlas CLI da OpenAI seguindo melhores prÃ¡ticas
################################################################################

set -e

# Cores para output
readonly GREEN='\033[0;32m'
readonly BLUE='\033[0;34m'
readonly RED='\033[0;31m'
readonly YELLOW='\033[1;33m'
readonly PURPLE='\033[0;35m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m'

# ConfiguraÃ§Ãµes
readonly ATLAS_VERSION="latest"
readonly INSTALL_DIR="/usr/local/bin"
readonly CONFIG_DIR="$HOME/.config/atlas-cli"
readonly DOTFILES_DIR="$DOTFILES_HOME/atlas-cli"

# FunÃ§Ãµes de log
log() { echo -e "${GREEN}[$(date +'%H:%M:%S')]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }
info() { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
debug() { echo -e "${PURPLE}[DEBUG]${NC} $1"; }

# Banner
show_banner() {
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘                    ATLAS CLI INSTALLER                        â•‘"
    echo -e "â•‘                   OpenAI Atlas Browser                        â•‘"
    echo -e "â•‘                    macOS Silicon Edition                       â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

# Verificar sistema
check_system() {
    log "Verificando sistema..."
    
    # Verificar macOS
    if [[ "$OSTYPE" != "darwin"* ]]; then
        error "Este script Ã© especÃ­fico para macOS"
        exit 1
    fi
    
    # Verificar arquitetura
    local arch=$(uname -m)
    if [[ "$arch" == "arm64" ]]; then
        info "âœ… Arquitetura: Apple Silicon (ARM64)"
    elif [[ "$arch" == "x86_64" ]]; then
        info "âœ… Arquitetura: Intel (x86_64)"
    else
        warn "âš ï¸ Arquitetura nÃ£o reconhecida: $arch"
    fi
    
    # Verificar Homebrew
    if ! command -v brew >/dev/null 2>&1; then
        warn "Homebrew nÃ£o encontrado"
        info "Instalando Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    else
        info "âœ… Homebrew encontrado"
    fi
    
    success "Sistema verificado"
}

# Instalar Atlas CLI
install_atlas_cli() {
    log "Instalando Atlas CLI..."
    
    # Verificar se jÃ¡ estÃ¡ instalado
    if command -v atlas-cli >/dev/null 2>&1; then
        local current_version=$(atlas-cli --version 2>/dev/null || echo "unknown")
        info "Atlas CLI jÃ¡ instalado: $current_version"
        
        read -p "Deseja reinstalar? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            info "Pulando instalaÃ§Ã£o"
            return 0
        fi
    fi
    
    # MÃ©todo 1: Tentar via Homebrew (se disponÃ­vel)
    if command -v brew >/dev/null 2>&1; then
        info "Tentando instalar via Homebrew..."
        if brew install atlas-cli 2>/dev/null; then
            success "âœ… Atlas CLI instalado via Homebrew"
            return 0
        else
            warn "Falha na instalaÃ§Ã£o via Homebrew"
        fi
    fi
    
    # MÃ©todo 2: Download direto
    info "Baixando Atlas CLI..."
    local download_url="https://github.com/atlas-cli/atlas-cli/releases/latest/download/atlas-cli-macos-arm64.tar.gz"
    
    if [[ "$(uname -m)" == "x86_64" ]]; then
        download_url="https://github.com/atlas-cli/atlas-cli/releases/latest/download/atlas-cli-macos-amd64.tar.gz"
    fi
    
    local temp_dir=$(mktemp -d)
    cd "$temp_dir"
    
    if curl -L -o atlas-cli.tar.gz "$download_url"; then
        tar -xzf atlas-cli.tar.gz
        sudo mv atlas-cli "$INSTALL_DIR/"
        sudo chmod +x "$INSTALL_DIR/atlas-cli"
        success "âœ… Atlas CLI instalado via download direto"
    else
        error "Falha no download do Atlas CLI"
        exit 1
    fi
    
    # Limpar arquivos temporÃ¡rios
    rm -rf "$temp_dir"
}

# Configurar ambiente
setup_environment() {
    log "Configurando ambiente..."
    
    # Criar diretÃ³rios
    mkdir -p "$CONFIG_DIR"
    mkdir -p "$DOTFILES_DIR"
    
    # Criar arquivo de configuraÃ§Ã£o
    cat > "$CONFIG_DIR/config.yaml" << 'EOF'
# Atlas CLI Configuration
api:
  base_url: "https://api.atlas.anthropic.com"
  timeout: 30
  retries: 3

browser:
  default_profile: "default"
  headless: false
  window_size: "1920x1080"

extensions:
  auto_install: true
  auto_update: true
  pinned_extensions:
    - "Promptheus"
    - "WebPilot"
    - "AIPRM"

logging:
  level: "info"
  file: "~/.config/atlas-cli/atlas.log"
  max_size: "10MB"
  max_files: 5

security:
  sandbox: true
  allow_unsafe_scripts: false
  content_security_policy: "strict"
EOF
    
    # Criar arquivo de aliases
    cat > "$DOTFILES_DIR/atlas-aliases.sh" << 'EOF'
# Atlas CLI Aliases
alias atlas='atlas-cli'
alias atlas-status='atlas-cli status'
alias atlas-extensions='atlas-cli extensions list'
alias atlas-pin='atlas-cli extensions pin'
alias atlas-unpin='atlas-cli extensions unpin'
alias atlas-login='atlas-cli login'
alias atlas-logout='atlas-cli logout'
alias atlas-config='atlas-cli config'
alias atlas-version='atlas-cli --version'

# FunÃ§Ãµes Ãºteis
atlas-pin-all() {
    echo "ğŸ”§ Fixando todas as extensÃµes..."
    atlas-cli extensions pin Promptheus
    atlas-cli extensions pin WebPilot
    atlas-cli extensions pin AIPRM
    echo "âœ… ExtensÃµes fixadas!"
}

atlas-unpin-all() {
    echo "ğŸ”§ Desfixando todas as extensÃµes..."
    atlas-cli extensions unpin Promptheus
    atlas-cli extensions unpin WebPilot
    atlas-cli extensions unpin AIPRM
    echo "âœ… ExtensÃµes desfixadas!"
}

atlas-restart() {
    echo "ğŸ”„ Reiniciando Atlas CLI..."
    pkill -f atlas-cli 2>/dev/null || true
    sleep 2
    atlas-cli start &
    echo "âœ… Atlas CLI reiniciado!"
}
EOF
    
    success "Ambiente configurado"
}

# Configurar autenticaÃ§Ã£o
setup_authentication() {
    log "Configurando autenticaÃ§Ã£o..."
    
    # Verificar se jÃ¡ estÃ¡ autenticado
    if atlas-cli status >/dev/null 2>&1; then
        info "âœ… Atlas CLI jÃ¡ autenticado"
        return 0
    fi
    
    warn "Atlas CLI nÃ£o estÃ¡ autenticado"
    info "Para autenticar:"
    echo "1. Execute: atlas-cli login"
    echo "2. Siga as instruÃ§Ãµes na tela"
    echo "3. Execute este script novamente"
    
    read -p "Deseja tentar autenticar agora? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        atlas-cli login
    fi
}

# Instalar extensÃµes
install_extensions() {
    log "Instalando extensÃµes..."
    
    local extensions=("Promptheus" "WebPilot" "AIPRM")
    
    for ext in "${extensions[@]}"; do
        info "Instalando extensÃ£o: $ext"
        if atlas-cli extensions install "$ext" >/dev/null 2>&1; then
            success "âœ… $ext instalada"
        else
            warn "âš ï¸ Falha ao instalar $ext"
        fi
    done
}

# Fixar extensÃµes
pin_extensions() {
    log "Fixando extensÃµes..."
    
    local extensions=("Promptheus" "WebPilot" "AIPRM")
    local success_count=0
    
    for ext in "${extensions[@]}"; do
        info "Fixando: $ext"
        if atlas-cli extensions pin "$ext" >/dev/null 2>&1; then
            success "âœ… $ext fixada"
            ((success_count++))
        else
            warn "âš ï¸ Falha ao fixar $ext"
        fi
    done
    
    info "ExtensÃµes fixadas: $success_count/${#extensions[@]}"
}

# Criar scripts de automaÃ§Ã£o
create_automation_scripts() {
    log "Criando scripts de automaÃ§Ã£o..."
    
    # Script de pinagem rÃ¡pida
    cat > "$DOTFILES_DIR/pin-extensions.sh" << 'EOF'
#!/bin/bash
# Script de pinagem rÃ¡pida das extensÃµes Atlas CLI

echo "ğŸ”§ Fixando extensÃµes Atlas CLI..."

extensions=("Promptheus" "WebPilot" "AIPRM")
success_count=0

for ext in "${extensions[@]}"; do
    echo "Fixando: $ext"
    if atlas-cli extensions pin "$ext" >/dev/null 2>&1; then
        echo "âœ… $ext fixada"
        ((success_count++))
    else
        echo "âŒ Falha ao fixar $ext"
    fi
done

echo "âœ… $success_count extensÃµes fixadas com sucesso!"
EOF
    
    # Script de status
    cat > "$DOTFILES_DIR/atlas-status.sh" << 'EOF'
#!/bin/bash
# Script de status do Atlas CLI

echo "ğŸ” Status do Atlas CLI"
echo "====================="

# Verificar se estÃ¡ instalado
if command -v atlas-cli >/dev/null 2>&1; then
    echo "âœ… Atlas CLI instalado: $(atlas-cli --version 2>/dev/null || echo 'unknown')"
else
    echo "âŒ Atlas CLI nÃ£o instalado"
    exit 1
fi

# Verificar autenticaÃ§Ã£o
if atlas-cli status >/dev/null 2>&1; then
    echo "âœ… Atlas CLI autenticado"
else
    echo "âŒ Atlas CLI nÃ£o autenticado"
fi

# Listar extensÃµes instaladas
echo ""
echo "ğŸ“¦ ExtensÃµes instaladas:"
atlas-cli extensions list 2>/dev/null || echo "Erro ao listar extensÃµes"

# Listar extensÃµes fixadas
echo ""
echo "ğŸ“Œ ExtensÃµes fixadas:"
atlas-cli extensions pinned 2>/dev/null || echo "Erro ao listar extensÃµes fixadas"
EOF
    
    # Tornar executÃ¡veis
    chmod +x "$DOTFILES_DIR"/*.sh
    
    success "Scripts de automaÃ§Ã£o criados"
}

# Configurar integraÃ§Ã£o com shell
setup_shell_integration() {
    log "Configurando integraÃ§Ã£o com shell..."
    
    local shell_rc=""
    
    # Detectar shell
    if [[ "$SHELL" == *"zsh"* ]]; then
        shell_rc="$HOME/.zshrc"
    elif [[ "$SHELL" == *"bash"* ]]; then
        shell_rc="$HOME/.bashrc"
    else
        warn "Shell nÃ£o reconhecido: $SHELL"
        return 0
    fi
    
    # Adicionar aliases ao shell
    if [[ -f "$shell_rc" ]]; then
        if ! grep -q "atlas-aliases" "$shell_rc"; then
            echo "" >> "$shell_rc"
            echo "# Atlas CLI Aliases" >> "$shell_rc"
            echo "source $DOTFILES_DIR/atlas-aliases.sh" >> "$shell_rc"
            success "Aliases adicionados ao $shell_rc"
        else
            info "Aliases jÃ¡ configurados no $shell_rc"
        fi
    else
        warn "Arquivo de configuraÃ§Ã£o do shell nÃ£o encontrado: $shell_rc"
    fi
}

# Testar instalaÃ§Ã£o
test_installation() {
    log "Testando instalaÃ§Ã£o..."
    
    # Verificar comando
    if ! command -v atlas-cli >/dev/null 2>&1; then
        error "Atlas CLI nÃ£o encontrado no PATH"
        return 1
    fi
    
    # Verificar versÃ£o
    local version=$(atlas-cli --version 2>/dev/null || echo "unknown")
    info "VersÃ£o instalada: $version"
    
    # Verificar autenticaÃ§Ã£o
    if atlas-cli status >/dev/null 2>&1; then
        success "âœ… Atlas CLI funcionando corretamente"
    else
        warn "âš ï¸ Atlas CLI nÃ£o autenticado"
    fi
    
    success "Teste concluÃ­do"
}

# Mostrar resumo
show_summary() {
    echo ""
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘                    INSTALAÃ‡ÃƒO CONCLUÃDA                        â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    info "ğŸ“ Arquivos criados:"
    echo "  â€¢ $CONFIG_DIR/config.yaml"
    echo "  â€¢ $DOTFILES_DIR/atlas-aliases.sh"
    echo "  â€¢ $DOTFILES_DIR/pin-extensions.sh"
    echo "  â€¢ $DOTFILES_DIR/atlas-status.sh"
    echo ""
    
    info "ğŸ”§ Comandos Ãºteis:"
    echo "  â€¢ atlas-status          - Verificar status"
    echo "  â€¢ atlas-extensions      - Listar extensÃµes"
    echo "  â€¢ atlas-pin-all         - Fixar todas as extensÃµes"
    echo "  â€¢ atlas-unpin-all       - Desfixar todas as extensÃµes"
    echo "  â€¢ atlas-restart         - Reiniciar Atlas CLI"
    echo ""
    
    info "ğŸ“‹ PrÃ³ximos passos:"
    echo "  1. Reinicie o terminal ou execute: source ~/.zshrc"
    echo "  2. Execute: atlas-login (se nÃ£o autenticado)"
    echo "  3. Execute: atlas-pin-all (para fixar extensÃµes)"
    echo "  4. Execute: atlas-status (para verificar)"
    echo ""
    
    success "ğŸ‰ Atlas CLI configurado com sucesso!"
}

# --- ExecuÃ§Ã£o Principal ---
main() {
    show_banner
    check_system
    install_atlas_cli
    setup_environment
    setup_authentication
    install_extensions
    pin_extensions
    create_automation_scripts
    setup_shell_integration
    test_installation
    show_summary
}

# Executar se chamado diretamente
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
