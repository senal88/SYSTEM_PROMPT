#!/usr/bin/env bash
set -euo pipefail

# Script para configurar 1Password CLI com o token identificado
# Resolve o problema de autenticaÃ§Ã£o usando o token correto

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo -e "â•‘                CONFIGURAÃ‡ÃƒO 1PASSWORD COM TOKEN                â•‘"
echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# 1. Verificar se o 1Password CLI estÃ¡ instalado
log "Verificando 1Password CLI..."
if ! command -v op >/dev/null 2>&1; then
    error "1Password CLI nÃ£o estÃ¡ instalado. Instalando..."
    brew install --cask 1password-cli
fi

# 2. Ler o token identificado
log "Lendo token do 1Password Connect..."
MACOS_TOKEN_FILE="$DOTFILES_HOME/automation_1password/connect/macos_connect_server/macos_conect_server.txt"

if [[ -f "$MACOS_TOKEN_FILE" ]]; then
    MACOS_TOKEN=$(cat "$MACOS_TOKEN_FILE" | tr -d '\n' | tr -d ' ')
    log "âœ… Token lido: ${MACOS_TOKEN:0:20}..."
else
    error "Arquivo de token nÃ£o encontrado: $MACOS_TOKEN_FILE"
    exit 1
fi

# 3. Configurar variÃ¡veis de ambiente
log "Configurando variÃ¡veis de ambiente..."
export OP_CONNECT_TOKEN="$MACOS_TOKEN"
export OP_CONNECT_HOST="http://localhost:8080"

# Adicionar ao perfil do shell
SHELL_PROFILE="$HOME/.zprofile"
if ! grep -q "OP_CONNECT_TOKEN" "$SHELL_PROFILE" 2>/dev/null; then
    echo "" >> "$SHELL_PROFILE"
    echo "# 1Password Connect Configuration" >> "$SHELL_PROFILE"
    echo "export OP_CONNECT_TOKEN='$MACOS_TOKEN'" >> "$SHELL_PROFILE"
    echo "export OP_CONNECT_HOST='http://localhost:8080'" >> "$SHELL_PROFILE"
    log "âœ… VariÃ¡veis adicionadas ao $SHELL_PROFILE"
fi

# 4. Verificar se o 1Password Connect Server estÃ¡ rodando
log "Verificando 1Password Connect Server..."
if curl -s "$OP_CONNECT_HOST/health" >/dev/null 2>&1; then
    log "âœ… 1Password Connect Server estÃ¡ rodando"
else
    warn "1Password Connect Server nÃ£o estÃ¡ rodando em $OP_CONNECT_HOST"
    info "Para iniciar o servidor:"
    echo "  cd $DOTFILES_HOME/automation_1password/connect"
    echo "  docker-compose up -d"
    echo ""
    read -p "Pressione Enter apÃ³s iniciar o servidor ou Ctrl+C para cancelar..."
fi

# 5. Testar autenticaÃ§Ã£o
log "Testando autenticaÃ§Ã£o com o token..."
if op item list >/dev/null 2>&1; then
    log "âœ… AutenticaÃ§Ã£o bem-sucedida!"
    
    # Listar alguns itens para verificar
    ITEM_COUNT=$(op item list --format=json | jq '. | length' 2>/dev/null || echo "0")
    log "âœ… Acesso a $ITEM_COUNT itens no vault"
    
else
    error "Falha na autenticaÃ§Ã£o. Verificando configuraÃ§Ãµes..."
    
    # Verificar se o token Ã© vÃ¡lido
    if [[ -n "$MACOS_TOKEN" ]]; then
        log "Token presente: ${MACOS_TOKEN:0:20}..."
        
        # Verificar formato JWT
        if [[ "$MACOS_TOKEN" =~ ^[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+$ ]]; then
            log "âœ… Token tem formato JWT vÃ¡lido"
        else
            error "âŒ Token nÃ£o tem formato JWT vÃ¡lido"
        fi
    else
        error "âŒ Token estÃ¡ vazio"
    fi
    
    # Verificar conectividade
    if curl -s "$OP_CONNECT_HOST/health" >/dev/null 2>&1; then
        log "âœ… Servidor estÃ¡ acessÃ­vel"
    else
        error "âŒ Servidor nÃ£o estÃ¡ acessÃ­vel"
    fi
    
    exit 1
fi

# 6. Configurar vault padrÃ£o
log "Configurando vault padrÃ£o..."
VAULT_ID="gkpsbgizlks2zknwzqpppnb2ze"  # ExtraÃ­do do token JWT
export OP_VAULT="$VAULT_ID"

# Adicionar ao perfil do shell
if ! grep -q "OP_VAULT" "$SHELL_PROFILE" 2>/dev/null; then
    echo "export OP_VAULT='$VAULT_ID'" >> "$SHELL_PROFILE"
    log "âœ… Vault padrÃ£o configurado: $VAULT_ID"
fi

# 7. Testar operaÃ§Ãµes bÃ¡sicas
log "Testando operaÃ§Ãµes bÃ¡sicas..."

# Listar itens
if op item list >/dev/null 2>&1; then
    log "âœ… Lista de itens funcionando"
else
    warn "âš ï¸  Lista de itens falhou"
fi

# Testar busca
if op item get "GitHub Token" >/dev/null 2>&1; then
    log "âœ… Busca por 'GitHub Token' funcionando"
else
    warn "âš ï¸  Item 'GitHub Token' nÃ£o encontrado"
fi

# 8. Criar script de teste
log "Criando script de teste..."
cat > "$PWD/test-1password-connection.sh" << 'BASH'
#!/bin/bash
# Script para testar conexÃ£o com 1Password

echo "ğŸ” Testando conexÃ£o com 1Password..."

# Carregar variÃ¡veis de ambiente
export OP_CONNECT_TOKEN='MACOS_TOKEN_PLACEHOLDER'
export OP_CONNECT_HOST='http://localhost:8080'
export OP_VAULT='gkpsbgizlks2zknwzqpppnb2ze'

# Testar conectividade
echo "1. Testando conectividade..."
if curl -s "$OP_CONNECT_HOST/health" >/dev/null 2>&1; then
    echo "âœ… Servidor acessÃ­vel"
else
    echo "âŒ Servidor nÃ£o acessÃ­vel"
    exit 1
fi

# Testar autenticaÃ§Ã£o
echo "2. Testando autenticaÃ§Ã£o..."
if op item list >/dev/null 2>&1; then
    echo "âœ… AutenticaÃ§Ã£o funcionando"
    
    # Contar itens
    ITEM_COUNT=$(op item list --format=json | jq '. | length' 2>/dev/null || echo "0")
    echo "âœ… Acesso a $ITEM_COUNT itens"
    
    # Listar alguns itens
    echo "3. Listando itens disponÃ­veis:"
    op item list --format=json | jq -r '.[] | "  - \(.title)"' 2>/dev/null | head -10
    
else
    echo "âŒ Falha na autenticaÃ§Ã£o"
    exit 1
fi

echo "ğŸ‰ Teste concluÃ­do com sucesso!"
BASH

# Substituir placeholder pelo token real
sed -i '' "s/MACOS_TOKEN_PLACEHOLDER/$MACOS_TOKEN/g" "$PWD/test-1password-connection.sh"
chmod +x "$PWD/test-1password-connection.sh"

log "âœ… Script de teste criado: test-1password-connection.sh"

# 9. Resumo final
echo ""
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo -e "â•‘                CONFIGURAÃ‡ÃƒO CONCLUÃDA!                        â•‘"
echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

info "ConfiguraÃ§Ãµes aplicadas:"
echo "âœ… Token: ${MACOS_TOKEN:0:20}..."
echo "âœ… Host: $OP_CONNECT_HOST"
echo "âœ… Vault: $VAULT_ID"
echo "âœ… VariÃ¡veis salvas em: $SHELL_PROFILE"

echo ""
info "Para testar a configuraÃ§Ã£o:"
echo "1. Execute: ./test-1password-connection.sh"
echo "2. Ou execute: op item list"
echo "3. Para buscar um item: op item get 'Nome do Item'"

echo ""
warn "Importante:"
echo "- Certifique-se de que o 1Password Connect Server estÃ¡ rodando"
echo "  cd $DOTFILES_HOME/automation_1password/connect"
echo "  docker-compose up -d"
echo "- Reinicie o terminal ou execute: source ~/.zprofile"

echo ""
log "ConfiguraÃ§Ã£o do 1Password concluÃ­da! ğŸ¯"
