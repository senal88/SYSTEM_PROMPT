#!/bin/bash
# ============================================================================
# ğŸš€ Setup Completo - 1Password Connect + Cursor
# Arquivo: scripts/setup-complete.sh
# PropÃ³sito: ConfiguraÃ§Ã£o completa do ambiente
# Data: 27 de Janeiro de 2025
# ============================================================================

set -e

echo "ğŸš€ Iniciando configuraÃ§Ã£o completa do ambiente..."

# 1. Verificar prÃ©-requisitos
echo "ğŸ” Verificando prÃ©-requisitos..."
command -v op >/dev/null 2>&1 || { echo "âŒ 1Password CLI nÃ£o encontrado"; exit 1; }
command -v docker >/dev/null 2>&1 || { echo "âŒ Docker nÃ£o encontrado"; exit 1; }

# 2. Carregar variÃ¡veis de ambiente
echo "ğŸ“‹ Carregando variÃ¡veis de ambiente..."
source $DOTFILES_HOME/automation_1password/scripts/secrets/load-secure-env.sh macos

echo "âœ… VariÃ¡veis carregadas:"
echo "   - Vault: $OP_VAULT"
echo "   - Host: $OP_CONNECT_HOST"
echo "   - Token: ${OP_CONNECT_TOKEN:0:20}..."

# 3. Testar conexÃ£o com 1Password Connect
echo "ğŸ” Testando conexÃ£o com 1Password Connect..."
if curl -s -H "Authorization: Bearer $OP_CONNECT_TOKEN" "$OP_CONNECT_HOST/v1/health" >/dev/null; then
  echo "âœ… ConexÃ£o com 1Password Connect estabelecida"
else
  echo "âŒ Falha ao conectar com 1Password Connect"
  echo "   Verifique se o servidor Connect estÃ¡ rodando em: $OP_CONNECT_HOST"
  exit 1
fi

# 4. Testar acesso aos vaults
echo "ğŸ¦ Testando acesso aos vaults..."
if curl -s -H "Authorization: Bearer $OP_CONNECT_TOKEN" "$OP_CONNECT_HOST/v1/vaults" >/dev/null; then
  echo "âœ… Acesso aos vaults confirmado"
else
  echo "âŒ Falha ao acessar vaults"
  exit 1
fi

# 5. Configurar Cursor
echo "ğŸ”§ Configurando Cursor..."
mkdir -p ~/.cursor

# Criar arquivo de ambiente para Cursor
cat > ~/.cursor/.env.macos << EOF
# ============================================================================
# ğŸ” Cursor Environment - macOS
# Arquivo: ~/.cursor/.env.macos
# PropÃ³sito: VariÃ¡veis de ambiente para Cursor no macOS
# ============================================================================

# 1Password Connect Configuration
export OP_VAULT="$OP_VAULT"
export OP_CONNECT_HOST="$OP_CONNECT_HOST"
export OP_CONNECT_TOKEN="$OP_CONNECT_TOKEN"

# API Keys (via 1Password Connect)
export OPENAI_API_KEY=\$(curl -s -H "Authorization: Bearer \$OP_CONNECT_TOKEN" "\$OP_CONNECT_HOST/v1/vaults/\$OP_VAULT/items/OpenAI%20API%20Key" | jq -r '.fields[] | select(.label=="api_key") | .value')
export ANTHROPIC_API_KEY=\$(curl -s -H "Authorization: Bearer \$OP_CONNECT_TOKEN" "\$OP_CONNECT_HOST/v1/vaults/\$OP_VAULT/items/Anthropic%20API%20Key" | jq -r '.fields[] | select(.label=="api_key") | .value')
export GEMINI_API_KEY=\$(curl -s -H "Authorization: Bearer \$OP_CONNECT_TOKEN" "\$OP_CONNECT_HOST/v1/vaults/\$OP_VAULT/items/Google%20Gemini%20API%20Key" | jq -r '.fields[] | select(.label=="api_key") | .value')
export PERPLEXITY_API_KEY=\$(curl -s -H "Authorization: Bearer \$OP_CONNECT_TOKEN" "\$OP_CONNECT_HOST/v1/vaults/\$OP_VAULT/items/Perplexity%20API%20Key" | jq -r '.fields[] | select(.label=="api_key") | .value')

# Database Configuration
export POSTGRES_HOST=\$(curl -s -H "Authorization: Bearer \$OP_CONNECT_TOKEN" "\$OP_CONNECT_HOST/v1/vaults/\$OP_VAULT/items/PostgreSQL%20Development" | jq -r '.fields[] | select(.label=="hostname") | .value')
export POSTGRES_PORT=\$(curl -s -H "Authorization: Bearer \$OP_CONNECT_TOKEN" "\$OP_CONNECT_HOST/v1/vaults/\$OP_VAULT/items/PostgreSQL%20Development" | jq -r '.fields[] | select(.label=="port") | .value')
export POSTGRES_USER=\$(curl -s -H "Authorization: Bearer \$OP_CONNECT_TOKEN" "\$OP_CONNECT_HOST/v1/vaults/\$OP_VAULT/items/PostgreSQL%20Development" | jq -r '.fields[] | select(.label=="username") | .value')
export POSTGRES_PASSWORD=\$(curl -s -H "Authorization: Bearer \$OP_CONNECT_TOKEN" "\$OP_CONNECT_HOST/v1/vaults/\$OP_VAULT/items/PostgreSQL%20Development" | jq -r '.fields[] | select(.label=="password") | .value')
export POSTGRES_DB=\$(curl -s -H "Authorization: Bearer \$OP_CONNECT_TOKEN" "\$OP_CONNECT_HOST/v1/vaults/\$OP_VAULT/items/PostgreSQL%20Development" | jq -r '.fields[] | select(.label=="database") | .value')

# SMTP Configuration
export SMTP_HOST=\$(curl -s -H "Authorization: Bearer \$OP_CONNECT_TOKEN" "\$OP_CONNECT_HOST/v1/vaults/\$OP_VAULT/items/SMTP%20Gmail%20Configuration" | jq -r '.fields[] | select(.label=="host") | .value')
export SMTP_PORT=\$(curl -s -H "Authorization: Bearer \$OP_CONNECT_TOKEN" "\$OP_CONNECT_HOST/v1/vaults/\$OP_VAULT/items/SMTP%20Gmail%20Configuration" | jq -r '.fields[] | select(.label=="port") | .value')
export SMTP_USER=\$(curl -s -H "Authorization: Bearer \$OP_CONNECT_TOKEN" "\$OP_CONNECT_HOST/v1/vaults/\$OP_VAULT/items/SMTP%20Gmail%20Configuration" | jq -r '.fields[] | select(.label=="username") | .value')
export SMTP_PASSWORD=\$(curl -s -H "Authorization: Bearer \$OP_CONNECT_TOKEN" "\$OP_CONNECT_HOST/v1/vaults/\$OP_VAULT/items/SMTP%20Gmail%20Configuration" | jq -r '.fields[] | select(.label=="password") | .value')
EOF

echo "âœ… Arquivo de ambiente do Cursor criado: ~/.cursor/.env.macos"

# 6. Configurar shell
echo "ğŸ“ Configurando shell..."
if ! grep -q "load-secure-env.sh macos" ~/.zshrc; then
  echo "source $DOTFILES_HOME/automation_1password/scripts/secrets/load-secure-env.sh macos" >> ~/.zshrc
  echo "âœ… ConfiguraÃ§Ã£o adicionada ao ~/.zshrc"
fi

# 7. Criar script de carregamento para Cursor
cat > $DOTFILES_HOME/automation_1password/scripts/bootstrap/load-cursor-env.sh << 'EOF'
#!/bin/bash
# ============================================================================
# ğŸ” Load Cursor Environment
# Arquivo: scripts/bootstrap/load-cursor-env.sh
# PropÃ³sito: Carregar variÃ¡veis de ambiente do Cursor
# ============================================================================

set -e

echo "ğŸ” Carregando variÃ¡veis de ambiente do Cursor..."

# Carregar variÃ¡veis do 1Password Connect
source $DOTFILES_HOME/automation_1password/scripts/secrets/load-secure-env.sh macos

# Carregar variÃ¡veis especÃ­ficas do Cursor
if [[ -f ~/.cursor/.env.macos ]]; then
  source ~/.cursor/.env.macos
  echo "âœ… VariÃ¡veis do Cursor carregadas"
else
  echo "âŒ Arquivo de ambiente do Cursor nÃ£o encontrado"
  exit 1
fi

echo "âœ… VariÃ¡veis carregadas com sucesso!"
echo "   - OpenAI API Key: ${OPENAI_API_KEY:0:10}..."
echo "   - Anthropic API Key: ${ANTHROPIC_API_KEY:0:10}..."
echo "   - Database: $POSTGRES_HOST:$POSTGRES_PORT"
echo "   - SMTP: $SMTP_HOST:$SMTP_PORT"
EOF

chmod +x $DOTFILES_HOME/automation_1password/scripts/bootstrap/load-cursor-env.sh

# 8. Testar carregamento de variÃ¡veis
echo "ğŸ§ª Testando carregamento de variÃ¡veis..."
source $DOTFILES_HOME/automation_1password/scripts/bootstrap/load-cursor-env.sh

# 9. Log da operaÃ§Ã£o
echo "$(date): Setup completo executado com sucesso" >> $DOTFILES_HOME/automation_1password/logs/automation.log

echo ""
echo "âœ… ConfiguraÃ§Ã£o completa finalizada!"
echo "ğŸ“‚ Logs: $DOTFILES_HOME/automation_1password/logs/automation.log"
echo "ğŸ”§ Scripts: $DOTFILES_HOME/automation_1password/scripts/bootstrap/"
echo "ğŸŒ Connect: $OP_CONNECT_HOST"
echo "ğŸ¦ Vault: $OP_VAULT"
echo ""
echo "ğŸ¯ PrÃ³ximos passos:"
echo "1. Execute: source $DOTFILES_HOME/automation_1password/scripts/bootstrap/load-cursor-env.sh"
echo "2. Verifique as variÃ¡veis: echo \$OPENAI_API_KEY"
echo "3. Configure o Cursor para usar essas variÃ¡veis"
