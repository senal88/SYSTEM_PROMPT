#!/usr/bin/env bash
set -euo pipefail

# === CONFIGURAÃ‡Ã•ES =============================================
ROOT="$DOTFILES_HOME/automation_1password"
REPORT="$ROOT/ARCHITECTURE_REPORT.md"
TMP_REPORT="$ROOT/.tmp_tree.txt"

echo "ğŸ“¦ Exportando arquitetura de: $ROOT"
cd "$ROOT"

# === GERA TREE =================================================
echo "ğŸ“ Gerando estrutura completa..."
find . -type d -not -path '*/\.*' | sort > "$TMP_REPORT"

# === EXPORTA RELATÃ“RIO MARKDOWN ================================
{
echo "# ğŸ§± Arquitetura Atual â€“ automation_1password"
echo ""
echo "**Gerado automaticamente:** $(date '+%Y-%m-%d %H:%M:%S')"
echo ""
echo "## ï¿½ï¿½ Estrutura Completa"
echo '```'
tree -a -I '.git|node_modules|__pycache__|*.log|*.tmp|*.DS_Store' .
echo '```'
echo ""
echo "## ğŸ” Duplicidades e InconsistÃªncias"
echo ""
echo "### ğŸ”¸ DiretÃ³rios duplicados"
find . -type d | awk -F/ '{print $NF}' | sort | uniq -d | sed 's/^/- /' || true
echo ""
echo "### ğŸ”¸ Arquivos duplicados"
find . -type f -not -path '*/\.*' -exec basename {} \; | sort | uniq -d | sed 's/^/- /' || true
echo ""
echo "### ğŸ”¸ Arquivos maiores que 10MB"
find . -type f -size +10M -exec du -h {} + | sort -rh | sed 's/^/- /' || echo "Nenhum arquivo grande encontrado."
echo ""
echo "### ğŸ”¸ Scripts sem permissÃ£o executÃ¡vel"
find scripts -type f -name "*.sh" ! -perm -u=x -print | sed 's/^/- /' || echo "Nenhum script invÃ¡lido."
echo ""
echo "## ğŸ§© SugestÃ£o de ReorganizaÃ§Ã£o"
echo "- Mover arquivos .env e .json sensÃ­veis para 'connect/' ou 'configs/'"
echo "- Consolidar templates duplicados em 'templates/env/'"
echo "- Garantir Makefile principal na raiz"
echo "- Atualizar README.md com links reais de cada mÃ³dulo"
echo ""
echo "## ğŸ“˜ README.md ValidaÃ§Ã£o"
if [ -f README.md ]; then
  echo "- Linhas Totais: $(wc -l < README.md)"
  echo "- ContÃ©m seÃ§Ã£o Quick Start? $(grep -q 'Quick Start' README.md && echo 'âœ… Sim' || echo 'âŒ NÃ£o')"
  echo "- ContÃ©m seÃ§Ã£o SeguranÃ§a? $(grep -q 'SeguranÃ§a' README.md && echo 'âœ… Sim' || echo 'âŒ NÃ£o')"
  echo "- ContÃ©m seÃ§Ã£o Workflows? $(grep -q 'Workflow' README.md && echo 'âœ… Sim' || echo 'âŒ NÃ£o')"
else
  echo "âŒ README.md nÃ£o encontrado."
fi
echo ""
echo "## âœ… PrÃ³ximos Passos"
echo "1. Validar duplicidades listadas acima"
echo "2. Atualizar README.md conforme o novo layout"
echo "3. Executar scripts de validaÃ§Ã£o:"
echo "   - bash scripts/validation/validate_environment_macos.sh"
echo "   - bash scripts/validation/validate_organization.sh"
echo "4. Regerar diagramas no Cursor IDE"
} > "$REPORT"

# === EXIBE RESULTADO ===========================================
echo "ğŸ“„ RelatÃ³rio gerado em: $REPORT"
echo ""
echo "ğŸ“Š Resumo da Arquitetura:"
echo "- DiretÃ³rios: $(find . -type d ! -path '*/\.*' | wc -l | tr -d ' ')"
echo "- Arquivos: $(find . -type f ! -path '*/\.*' | wc -l | tr -d ' ')"
echo "- Scripts: $(find scripts -type f -name "*.sh" 2>/dev/null | wc -l | tr -d ' ')"
echo "- DocumentaÃ§Ã£o: $(find . -name "*.md" ! -path '*/\.*' | wc -l | tr -d ' ')"
echo ""
echo "âœ… RelatÃ³rio completo disponÃ­vel em: ARCHITECTURE_REPORT.md"

