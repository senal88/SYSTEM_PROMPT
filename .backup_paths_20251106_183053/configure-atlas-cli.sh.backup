#!/bin/bash
################################################################################
# ATLAS CLI - CONFIGURADOR MODERNO
# Script de configuraÃ§Ã£o e gerenciamento do Atlas CLI
################################################################################

set -e

# Cores para output
readonly GREEN='\033[0;32m'
readonly BLUE='\033[0;34m'
readonly RED='\033[0;31m'
readonly YELLOW='\033[1;33m'
readonly PURPLE='\033[0;35m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m'

# ConfiguraÃ§Ãµes
readonly CONFIG_DIR="$HOME/.config/atlas-cli"
readonly DOTFILES_DIR="$DOTFILES_HOME/atlas-cli"
readonly LOG_FILE="$CONFIG_DIR/atlas.log"

# FunÃ§Ãµes de log
log() { echo -e "${GREEN}[$(date +'%H:%M:%S')]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }
info() { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
debug() { echo -e "${PURPLE}[DEBUG]${NC} $1"; }

# Banner
show_banner() {
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘                  ATLAS CLI CONFIGURATOR                       â•‘"
    echo -e "â•‘                   OpenAI Atlas Browser                        â•‘"
    echo -e "â•‘                    macOS Silicon Edition                       â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

# Verificar se Atlas CLI estÃ¡ instalado
check_atlas_cli() {
    log "Verificando Atlas CLI..."
    
    if ! command -v atlas-cli >/dev/null 2>&1; then
        error "Atlas CLI nÃ£o estÃ¡ instalado"
        info "Execute primeiro: ./install-atlas-cli.sh"
        exit 1
    fi
    
    local version=$(atlas-cli --version 2>/dev/null || echo "unknown")
    success "âœ… Atlas CLI encontrado: $version"
}

# Verificar autenticaÃ§Ã£o
check_authentication() {
    log "Verificando autenticaÃ§Ã£o..."
    
    if atlas-cli status >/dev/null 2>&1; then
        success "âœ… Atlas CLI autenticado"
        return 0
    else
        warn "Atlas CLI nÃ£o estÃ¡ autenticado"
        info "Para autenticar:"
        echo "1. Execute: atlas-cli login"
        echo "2. Siga as instruÃ§Ãµes na tela"
        echo "3. Execute este script novamente"
        
        read -p "Deseja tentar autenticar agora? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            atlas-cli login
            if atlas-cli status >/dev/null 2>&1; then
                success "âœ… AutenticaÃ§Ã£o bem-sucedida"
            else
                error "Falha na autenticaÃ§Ã£o"
                exit 1
            fi
        else
            error "AutenticaÃ§Ã£o necessÃ¡ria para continuar"
            exit 1
        fi
    fi
}

# Listar extensÃµes disponÃ­veis
list_available_extensions() {
    log "Listando extensÃµes disponÃ­veis..."
    
    if atlas-cli extensions list >/dev/null 2>&1; then
        info "ExtensÃµes instaladas:"
        atlas-cli extensions list
        echo ""
    else
        warn "Erro ao listar extensÃµes"
    fi
}

# Instalar extensÃµes essenciais
install_essential_extensions() {
    log "Instalando extensÃµes essenciais..."
    
    local extensions=(
        "Promptheus"
        "WebPilot" 
        "AIPRM"
        "CodeRunner"
        "PDFReader"
        "ImageGenerator"
    )
    
    local success_count=0
    
    for ext in "${extensions[@]}"; do
        info "Instalando: $ext"
        if atlas-cli extensions install "$ext" >/dev/null 2>&1; then
            success "âœ… $ext instalada"
            ((success_count++))
        else
            warn "âš ï¸ Falha ao instalar $ext (pode jÃ¡ estar instalada)"
        fi
    done
    
    info "ExtensÃµes instaladas: $success_count/${#extensions[@]}"
}

# Fixar extensÃµes na barra
pin_extensions() {
    log "Fixando extensÃµes na barra..."
    
    local extensions=("Promptheus" "WebPilot" "AIPRM")
    local success_count=0
    
    for ext in "${extensions[@]}"; do
        info "Fixando: $ext"
        if atlas-cli extensions pin "$ext" >/dev/null 2>&1; then
            success "âœ… $ext fixada"
            ((success_count++))
        else
            warn "âš ï¸ Falha ao fixar $ext"
        fi
    done
    
    info "ExtensÃµes fixadas: $success_count/${#extensions[@]}"
}

# Configurar perfil personalizado
setup_custom_profile() {
    log "Configurando perfil personalizado..."
    
    # Criar perfil personalizado
    cat > "$CONFIG_DIR/profile.json" << 'EOF'
{
  "name": "luiz-sena88",
  "description": "Perfil personalizado para Luiz Sena",
  "settings": {
    "theme": "dark",
    "language": "pt-BR",
    "auto_save": true,
    "notifications": true,
    "auto_update": true
  },
  "extensions": {
    "pinned": ["Promptheus", "WebPilot", "AIPRM"],
    "enabled": ["CodeRunner", "PDFReader", "ImageGenerator"]
  },
  "shortcuts": {
    "new_tab": "Cmd+T",
    "close_tab": "Cmd+W",
    "reload": "Cmd+R",
    "dev_tools": "Cmd+Option+I"
  }
}
EOF
    
    success "Perfil personalizado criado"
}

# Configurar atalhos personalizados
setup_custom_shortcuts() {
    log "Configurando atalhos personalizados..."
    
    cat > "$DOTFILES_DIR/atlas-shortcuts.sh" << 'EOF'
#!/bin/bash
# Atalhos personalizados para Atlas CLI

# FunÃ§Ã£o para abrir Atlas com configuraÃ§Ãµes especÃ­ficas
atlas-open() {
    local profile="${1:-default}"
    echo "ğŸŒ Abrindo Atlas CLI com perfil: $profile"
    atlas-cli open --profile "$profile"
}

# FunÃ§Ã£o para criar nova sessÃ£o
atlas-new-session() {
    echo "ğŸ†• Criando nova sessÃ£o Atlas..."
    atlas-cli session new
}

# FunÃ§Ã£o para listar sessÃµes ativas
atlas-sessions() {
    echo "ğŸ“‹ SessÃµes ativas:"
    atlas-cli session list
}

# FunÃ§Ã£o para fechar sessÃ£o especÃ­fica
atlas-close-session() {
    local session_id="$1"
    if [ -z "$session_id" ]; then
        echo "âŒ ID da sessÃ£o necessÃ¡rio"
        echo "Uso: atlas-close-session <session_id>"
        return 1
    fi
    echo "ğŸ”’ Fechando sessÃ£o: $session_id"
    atlas-cli session close "$session_id"
}

# FunÃ§Ã£o para backup de configuraÃ§Ãµes
atlas-backup() {
    local backup_dir="$HOME/Backups/atlas-cli"
    local timestamp=$(date +"%Y%m%d_%H%M%S")
    
    echo "ğŸ’¾ Fazendo backup das configuraÃ§Ãµes..."
    mkdir -p "$backup_dir"
    
    cp -r "$HOME/.config/atlas-cli" "$backup_dir/atlas-cli_$timestamp"
    
    echo "âœ… Backup criado em: $backup_dir/atlas-cli_$timestamp"
}

# FunÃ§Ã£o para restaurar configuraÃ§Ãµes
atlas-restore() {
    local backup_path="$1"
    
    if [ -z "$backup_path" ]; then
        echo "âŒ Caminho do backup necessÃ¡rio"
        echo "Uso: atlas-restore <backup_path>"
        return 1
    fi
    
    if [ ! -d "$backup_path" ]; then
        echo "âŒ Backup nÃ£o encontrado: $backup_path"
        return 1
    fi
    
    echo "ğŸ”„ Restaurando configuraÃ§Ãµes de: $backup_path"
    cp -r "$backup_path"/* "$HOME/.config/atlas-cli/"
    
    echo "âœ… ConfiguraÃ§Ãµes restauradas"
}

# FunÃ§Ã£o para limpeza
atlas-cleanup() {
    echo "ğŸ§¹ Limpando arquivos temporÃ¡rios..."
    
    # Limpar logs antigos
    find "$HOME/.config/atlas-cli" -name "*.log" -mtime +7 -delete 2>/dev/null || true
    
    # Limpar cache
    rm -rf "$HOME/.cache/atlas-cli" 2>/dev/null || true
    
    echo "âœ… Limpeza concluÃ­da"
}

# FunÃ§Ã£o para diagnÃ³stico completo
atlas-diagnose() {
    echo "ğŸ” DiagnÃ³stico do Atlas CLI"
    echo "=========================="
    
    # Verificar instalaÃ§Ã£o
    if command -v atlas-cli >/dev/null 2>&1; then
        echo "âœ… Atlas CLI instalado: $(atlas-cli --version 2>/dev/null || echo 'unknown')"
    else
        echo "âŒ Atlas CLI nÃ£o instalado"
        return 1
    fi
    
    # Verificar autenticaÃ§Ã£o
    if atlas-cli status >/dev/null 2>&1; then
        echo "âœ… Atlas CLI autenticado"
    else
        echo "âŒ Atlas CLI nÃ£o autenticado"
    fi
    
    # Verificar configuraÃ§Ãµes
    if [ -d "$HOME/.config/atlas-cli" ]; then
        echo "âœ… DiretÃ³rio de configuraÃ§Ã£o existe"
    else
        echo "âŒ DiretÃ³rio de configuraÃ§Ã£o nÃ£o encontrado"
    fi
    
    # Verificar extensÃµes
    echo ""
    echo "ğŸ“¦ ExtensÃµes instaladas:"
    atlas-cli extensions list 2>/dev/null || echo "Erro ao listar extensÃµes"
    
    echo ""
    echo "ğŸ“Œ ExtensÃµes fixadas:"
    atlas-cli extensions pinned 2>/dev/null || echo "Erro ao listar extensÃµes fixadas"
}
EOF
    
    chmod +x "$DOTFILES_DIR/atlas-shortcuts.sh"
    success "Atalhos personalizados criados"
}

# Configurar integraÃ§Ã£o com Raycast
setup_raycast_integration() {
    log "Configurando integraÃ§Ã£o com Raycast..."
    
    # Criar script para Raycast
    cat > "$DOTFILES_DIR/raycast-atlas.sh" << 'EOF'
#!/bin/bash
# Raycast integration for Atlas CLI

# Required parameters:
# @raycast.title Atlas CLI Control
# @raycast.author Luiz Sena
# @raycast.description Control Atlas CLI from Raycast
# @raycast.mode full
# @raycast.packageName Atlas CLI
# @raycast.icon ğŸŒ

# @raycast.argument1 { "type": "text", "placeholder": "Action (open, status, extensions, pin)", "optional": true }

action="${1:-status}"

case "$action" in
    "open")
        echo "ğŸŒ Abrindo Atlas CLI..."
        atlas-cli open
        ;;
    "status")
        echo "ğŸ” Status do Atlas CLI:"
        atlas-cli status
        ;;
    "extensions")
        echo "ğŸ“¦ ExtensÃµes instaladas:"
        atlas-cli extensions list
        ;;
    "pin")
        echo "ğŸ“Œ Fixando extensÃµes..."
        atlas-cli extensions pin Promptheus
        atlas-cli extensions pin WebPilot
        atlas-cli extensions pin AIPRM
        echo "âœ… ExtensÃµes fixadas!"
        ;;
    *)
        echo "âŒ AÃ§Ã£o invÃ¡lida: $action"
        echo ""
        echo "ğŸ’¡ AÃ§Ãµes disponÃ­veis:"
        echo "  open        - Abrir Atlas CLI"
        echo "  status      - Verificar status"
        echo "  extensions  - Listar extensÃµes"
        echo "  pin         - Fixar extensÃµes"
        ;;
esac
EOF
    
    chmod +x "$DOTFILES_DIR/raycast-atlas.sh"
    success "IntegraÃ§Ã£o com Raycast criada"
}

# Configurar monitoramento
setup_monitoring() {
    log "Configurando monitoramento..."
    
    # Criar script de monitoramento
    cat > "$DOTFILES_DIR/atlas-monitor.sh" << 'EOF'
#!/bin/bash
# Monitor de Atlas CLI

LOG_FILE="$HOME/.config/atlas-cli/atlas.log"
PID_FILE="$HOME/.config/atlas-cli/atlas.pid"

start_monitoring() {
    echo "ğŸ” Iniciando monitoramento do Atlas CLI..."
    
    # Verificar se jÃ¡ estÃ¡ rodando
    if [ -f "$PID_FILE" ] && kill -0 "$(cat "$PID_FILE")" 2>/dev/null; then
        echo "âš ï¸ Monitor jÃ¡ estÃ¡ rodando (PID: $(cat "$PID_FILE"))"
        return 1
    fi
    
    # Iniciar monitor em background
    nohup bash -c '
        while true; do
            if ! atlas-cli status >/dev/null 2>&1; then
                echo "$(date): Atlas CLI nÃ£o estÃ¡ respondendo" >> "$LOG_FILE"
            fi
            sleep 30
        done
    ' >/dev/null 2>&1 &
    
    echo $! > "$PID_FILE"
    echo "âœ… Monitor iniciado (PID: $!)"
}

stop_monitoring() {
    echo "ğŸ›‘ Parando monitoramento..."
    
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE")
        if kill -0 "$pid" 2>/dev/null; then
            kill "$pid"
            rm -f "$PID_FILE"
            echo "âœ… Monitor parado"
        else
            echo "âš ï¸ Monitor nÃ£o estava rodando"
            rm -f "$PID_FILE"
        fi
    else
        echo "âš ï¸ Arquivo PID nÃ£o encontrado"
    fi
}

status_monitoring() {
    if [ -f "$PID_FILE" ] && kill -0 "$(cat "$PID_FILE")" 2>/dev/null; then
        echo "âœ… Monitor ativo (PID: $(cat "$PID_FILE"))"
    else
        echo "âŒ Monitor inativo"
    fi
}

case "${1:-status}" in
    "start")
        start_monitoring
        ;;
    "stop")
        stop_monitoring
        ;;
    "restart")
        stop_monitoring
        sleep 2
        start_monitoring
        ;;
    "status")
        status_monitoring
        ;;
    *)
        echo "Uso: $0 {start|stop|restart|status}"
        ;;
esac
EOF
    
    chmod +x "$DOTFILES_DIR/atlas-monitor.sh"
    success "Sistema de monitoramento criado"
}

# Testar configuraÃ§Ã£o
test_configuration() {
    log "Testando configuraÃ§Ã£o..."
    
    # Testar comando bÃ¡sico
    if ! atlas-cli --version >/dev/null 2>&1; then
        error "Falha no teste bÃ¡sico do Atlas CLI"
        return 1
    fi
    
    # Testar status
    if ! atlas-cli status >/dev/null 2>&1; then
        warn "Atlas CLI nÃ£o autenticado (teste de status falhou)"
    fi
    
    # Testar listagem de extensÃµes
    if ! atlas-cli extensions list >/dev/null 2>&1; then
        warn "Falha ao listar extensÃµes"
    fi
    
    success "Teste de configuraÃ§Ã£o concluÃ­do"
}

# Mostrar resumo
show_summary() {
    echo ""
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘                  CONFIGURAÃ‡ÃƒO CONCLUÃDA                       â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    info "ğŸ“ Arquivos criados:"
    echo "  â€¢ $CONFIG_DIR/profile.json"
    echo "  â€¢ $DOTFILES_DIR/atlas-shortcuts.sh"
    echo "  â€¢ $DOTFILES_DIR/raycast-atlas.sh"
    echo "  â€¢ $DOTFILES_DIR/atlas-monitor.sh"
    echo ""
    
    info "ğŸ”§ Comandos Ãºteis:"
    echo "  â€¢ atlas-open              - Abrir Atlas CLI"
    echo "  â€¢ atlas-new-session       - Nova sessÃ£o"
    echo "  â€¢ atlas-sessions          - Listar sessÃµes"
    echo "  â€¢ atlas-backup            - Backup configuraÃ§Ãµes"
    echo "  â€¢ atlas-restore           - Restaurar configuraÃ§Ãµes"
    echo "  â€¢ atlas-cleanup           - Limpeza"
    echo "  â€¢ atlas-diagnose          - DiagnÃ³stico completo"
    echo ""
    
    info "ğŸ“± IntegraÃ§Ã£o Raycast:"
    echo "  â€¢ Copie: $DOTFILES_DIR/raycast-atlas.sh"
    echo "  â€¢ Para: ~/Library/Application Support/Raycast/Scripts/"
    echo ""
    
    info "ğŸ” Monitoramento:"
    echo "  â€¢ $DOTFILES_DIR/atlas-monitor.sh start"
    echo "  â€¢ $DOTFILES_DIR/atlas-monitor.sh stop"
    echo "  â€¢ $DOTFILES_DIR/atlas-monitor.sh status"
    echo ""
    
    success "ğŸ‰ Atlas CLI configurado com sucesso!"
}

# Menu principal
show_menu() {
    echo ""
    echo "ğŸ”§ Menu de ConfiguraÃ§Ã£o Atlas CLI"
    echo "================================="
    echo ""
    echo "1. Verificar instalaÃ§Ã£o"
    echo "2. Verificar autenticaÃ§Ã£o"
    echo "3. Listar extensÃµes"
    echo "4. Instalar extensÃµes essenciais"
    echo "5. Fixar extensÃµes"
    echo "6. Configurar perfil personalizado"
    echo "7. Configurar atalhos personalizados"
    echo "8. Configurar integraÃ§Ã£o Raycast"
    echo "9. Configurar monitoramento"
    echo "10. Testar configuraÃ§Ã£o"
    echo "11. Executar tudo (recomendado)"
    echo "0. Sair"
    echo ""
}

# Executar tudo
run_all() {
    show_banner
    check_atlas_cli
    check_authentication
    list_available_extensions
    install_essential_extensions
    pin_extensions
    setup_custom_profile
    setup_custom_shortcuts
    setup_raycast_integration
    setup_monitoring
    test_configuration
    show_summary
}

# --- ExecuÃ§Ã£o Principal ---
main() {
    if [ $# -eq 0 ]; then
        show_menu
        read -p "Escolha uma opÃ§Ã£o: " choice
        case $choice in
            1) check_atlas_cli ;;
            2) check_authentication ;;
            3) list_available_extensions ;;
            4) install_essential_extensions ;;
            5) pin_extensions ;;
            6) setup_custom_profile ;;
            7) setup_custom_shortcuts ;;
            8) setup_raycast_integration ;;
            9) setup_monitoring ;;
            10) test_configuration ;;
            11) run_all ;;
            0) echo "Saindo..."; exit 0 ;;
            *) echo "OpÃ§Ã£o invÃ¡lida"; exit 1 ;;
        esac
    else
        case "$1" in
            "install") check_atlas_cli ;;
            "auth") check_authentication ;;
            "extensions") list_available_extensions ;;
            "install-ext") install_essential_extensions ;;
            "pin") pin_extensions ;;
            "profile") setup_custom_profile ;;
            "shortcuts") setup_custom_shortcuts ;;
            "raycast") setup_raycast_integration ;;
            "monitor") setup_monitoring ;;
            "test") test_configuration ;;
            "all") run_all ;;
            *) echo "Uso: $0 [install|auth|extensions|install-ext|pin|profile|shortcuts|raycast|monitor|test|all]"; exit 1 ;;
        esac
    fi
}

# Executar se chamado diretamente
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
