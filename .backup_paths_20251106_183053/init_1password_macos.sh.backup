#!/bin/bash

################################################################################
# ğŸ” init_1password_macos.sh
# Script de InicializaÃ§Ã£o do 1Password CLI para macOS Silicon
# PropÃ³sito: Configurar o 1Password CLI com autenticaÃ§Ã£o biomÃ©trica
# Autor: Manus AI
# Data: 2025-10-22
################################################################################

set -euo pipefail

# ============================================================================
# CORES PARA OUTPUT
# ============================================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ============================================================================
# FUNÃ‡Ã•ES AUXILIARES
# ============================================================================

log_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# ============================================================================
# VERIFICAÃ‡ÃƒO DE PRÃ‰-REQUISITOS
# ============================================================================

check_prerequisites() {
    log_info "Verificando prÃ©-requisitos..."

    # Verificar se estÃ¡ no macOS
    if [[ "$OSTYPE" != "darwin"* ]]; then
        log_error "Este script Ã© especÃ­fico para macOS. Seu sistema operacional Ã©: $OSTYPE"
        exit 1
    fi

    # Verificar se Ã© Apple Silicon
    ARCH=$(uname -m)
    if [[ "$ARCH" != "arm64" ]]; then
        log_warning "Este script foi otimizado para Apple Silicon (arm64). Sua arquitetura Ã©: $ARCH"
    fi

    # Verificar se Homebrew estÃ¡ instalado
    if ! command -v brew &> /dev/null; then
        log_error "Homebrew nÃ£o estÃ¡ instalado. Instale em: https://brew.sh"
        exit 1
    fi

    log_success "PrÃ©-requisitos verificados."
}

# ============================================================================
# INSTALAÃ‡ÃƒO DO 1PASSWORD CLI
# ============================================================================

install_1password_cli() {
    log_info "Verificando instalaÃ§Ã£o do 1Password CLI..."

    if command -v op &> /dev/null; then
        OP_VERSION=$(op --version)
        log_success "1Password CLI jÃ¡ estÃ¡ instalado: $OP_VERSION"
        return 0
    fi

    log_info "Instalando 1Password CLI via Homebrew..."
    brew install 1password-cli

    if command -v op &> /dev/null; then
        log_success "1Password CLI instalado com sucesso: $(op --version)"
    else
        log_error "Falha ao instalar 1Password CLI."
        exit 1
    fi
}

# ============================================================================
# VERIFICAÃ‡ÃƒO DO 1PASSWORD DESKTOP APP
# ============================================================================

check_1password_desktop_app() {
    log_info "Verificando 1Password Desktop App..."

    if [[ -d "/Applications/1Password 7.app" ]] || [[ -d "/Applications/1Password.app" ]]; then
        log_success "1Password Desktop App encontrado."
        return 0
    else
        log_warning "1Password Desktop App nÃ£o encontrado em /Applications."
        log_info "VocÃª pode baixar em: https://1password.com/downloads/mac/"
        return 1
    fi
}

# ============================================================================
# AUTENTICAÃ‡ÃƒO BIOMÃ‰TRICA
# ============================================================================

configure_biometric_auth() {
    log_info "Configurando autenticaÃ§Ã£o biomÃ©trica..."

    # Verificar se Touch ID estÃ¡ disponÃ­vel
    if system_profiler SPBiometricInformation 2>/dev/null | grep -q "Touch ID"; then
        log_success "Touch ID estÃ¡ disponÃ­vel no sistema."
    elif system_profiler SPBiometricInformation 2>/dev/null | grep -q "Face ID"; then
        log_success "Face ID estÃ¡ disponÃ­vel no sistema."
    else
        log_warning "Nenhum sensor biomÃ©trico detectado. VocÃª pode usar Apple Watch para desbloqueio."
    fi

    log_info "Para ativar a autenticaÃ§Ã£o biomÃ©trica:"
    log_info "1. Abra o 1Password Desktop App"
    log_info "2. VÃ¡ para Settings > Security"
    log_info "3. Habilite 'Unlock with Touch ID' ou 'Unlock with Apple Watch'"
}

# ============================================================================
# TESTE DE CONECTIVIDADE
# ============================================================================

test_connectivity() {
    log_info "Testando conectividade com 1Password..."

    # Tentar listar vaults
    if op vault list &>/dev/null; then
        log_success "Conectividade com 1Password estabelecida."
        return 0
    else
        log_warning "NÃ£o foi possÃ­vel conectar ao 1Password. VocÃª pode precisar fazer login."
        log_info "Execute: eval \$(op signin)"
        return 1
    fi
}

# ============================================================================
# CONFIGURAÃ‡ÃƒO DO SHELL (ZSH)
# ============================================================================

configure_shell() {
    log_info "Configurando shell (Zsh)..."

    ZSHRC="$HOME/.zshrc"

    # Verificar se .zshrc existe
    if [[ ! -f "$ZSHRC" ]]; then
        log_warning "Arquivo .zshrc nÃ£o encontrado. Criando..."
        touch "$ZSHRC"
    fi

    # Adicionar configuraÃ§Ã£o do 1Password se nÃ£o existir
    if ! grep -q "# 1Password CLI Configuration" "$ZSHRC"; then
        log_info "Adicionando configuraÃ§Ã£o do 1Password ao .zshrc..."

        cat >> "$ZSHRC" << 'EOF'

# ============================================================================
# 1Password CLI Configuration
# ============================================================================

# FunÃ§Ã£o para fazer signin com biometria
op_signin() {
    eval $(op signin)
    log_success "Autenticado no 1Password com sucesso."
}

# FunÃ§Ã£o para verificar status da sessÃ£o
op_status() {
    if op whoami &>/dev/null; then
        echo "âœ… Conectado ao 1Password"
        op whoami
    else
        echo "âŒ NÃ£o conectado ao 1Password"
        echo "Execute: op_signin"
    fi
}

# Alias para leitura rÃ¡pida de segredos
alias op_read='op read'
alias op_list='op item list'

# FunÃ§Ã£o para injetar segredos em um arquivo .env.op
op_inject_env() {
    if [[ -z "$1" ]]; then
        echo "Uso: op_inject_env <arquivo.env.op>"
        return 1
    fi
    op inject -i "$1" -o .env
    echo "âœ… Arquivo .env gerado a partir de $1"
}

EOF

        log_success "ConfiguraÃ§Ã£o do 1Password adicionada ao .zshrc."
    else
        log_success "ConfiguraÃ§Ã£o do 1Password jÃ¡ existe no .zshrc."
    fi

    # Recarregar .zshrc
    source "$ZSHRC"
}

# ============================================================================
# CRIAÃ‡ÃƒO DE ESTRUTURA DE DIRETÃ“RIOS
# ============================================================================

create_directory_structure() {
    log_info "Criando estrutura de diretÃ³rios..."

    DOTFILES_DIR="$DOTFILES_HOME"
    OP_SCRIPTS_DIR="$DOTFILES_DIR/1password_automation"
    OP_ENV_DIR="$HOME/.config/1password"

    # Criar diretÃ³rios se nÃ£o existirem
    mkdir -p "$OP_SCRIPTS_DIR"
    mkdir -p "$OP_ENV_DIR"

    log_success "Estrutura de diretÃ³rios criada:"
    log_info "  - Scripts: $OP_SCRIPTS_DIR"
    log_info "  - ConfiguraÃ§Ã£o: $OP_ENV_DIR"
}

# ============================================================================
# TESTE DE FUNCIONAMENTO
# ============================================================================

test_functionality() {
    log_info "Testando funcionalidade do 1Password CLI..."

    # Tentar executar um comando simples
    if op --version &>/dev/null; then
        log_success "1Password CLI estÃ¡ funcionando corretamente."
    else
        log_error "Falha ao executar 1Password CLI."
        return 1
    fi

    # Tentar listar vaults
    if op vault list &>/dev/null; then
        log_success "Acesso aos vaults estÃ¡ funcionando."
        log_info "Vaults disponÃ­veis:"
        op vault list --format json | jq -r '.[] | "  - \(.name)"'
    else
        log_warning "NÃ£o foi possÃ­vel listar os vaults. VocÃª pode precisar fazer login."
    fi
}

# ============================================================================
# FUNÃ‡ÃƒO PRINCIPAL
# ============================================================================

main() {
    echo ""
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘  ğŸ” InicializaÃ§Ã£o do 1Password CLI para macOS Silicon          â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    check_prerequisites
    install_1password_cli
    check_1password_desktop_app || log_warning "Desktop App nÃ£o encontrado, mas CLI pode funcionar com Service Account Token."
    configure_biometric_auth
    configure_shell
    create_directory_structure
    test_functionality

    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘  âœ… InicializaÃ§Ã£o ConcluÃ­da!                                   â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    log_info "PrÃ³ximos passos:"
    log_info "1. Abra uma nova janela de terminal para carregar as configuraÃ§Ãµes"
    log_info "2. Execute: op_signin (para autenticar com biometria)"
    log_info "3. Execute: op_status (para verificar a conexÃ£o)"
    log_info "4. Crie vaults e itens no 1Password conforme necessÃ¡rio"
    echo ""
}

# ============================================================================
# EXECUÃ‡ÃƒO
# ============================================================================

main "$@"

