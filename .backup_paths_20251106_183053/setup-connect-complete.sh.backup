#!/bin/bash
# ============================================================================
# ğŸš€ Setup Completo - 1Password Connect Server (macOS Silicon)
# Arquivo: scripts/setup-connect-complete.sh
# PropÃ³sito: ConfiguraÃ§Ã£o completa para produÃ§Ã£o
# Data: 27 de Janeiro de 2025
# ============================================================================

set -e

echo "ğŸš€ Configurando 1Password Connect Server completo (macOS Silicon)..."

# 1. Verificar prÃ©-requisitos
echo "ğŸ” Verificando prÃ©-requisitos..."
command -v docker >/dev/null 2>&1 || { echo "âŒ Docker nÃ£o encontrado"; exit 1; }
command -v curl >/dev/null 2>&1 || { echo "âŒ curl nÃ£o encontrado"; exit 1; }

# 2. Carregar variÃ¡veis de ambiente
echo "ğŸ“‹ Carregando variÃ¡veis de ambiente..."
source ~/.1password/.env

if [[ -z "$OP_CONNECT_TOKEN" ]]; then
  echo "âŒ OP_CONNECT_TOKEN nÃ£o encontrado"
  exit 1
fi

echo "âœ… Token carregado: ${OP_CONNECT_TOKEN:0:20}..."

# 3. Criar estrutura de diretÃ³rios
echo "ğŸ“ Criando estrutura de diretÃ³rios..."
mkdir -p $DOTFILES_HOME/automation_1password/connect/{data,certs}
mkdir -p $DOTFILES_HOME/automation_1password/logs

# 4. Configurar credenciais
echo "ğŸ”‘ Configurando credenciais..."
if [[ ! -f $DOTFILES_HOME/automation_1password/connect/credentials.json ]]; then
  echo "âŒ Arquivo credentials.json nÃ£o encontrado"
  echo "   Copie o arquivo de credenciais para:"
  echo "   $DOTFILES_HOME/automation_1password/connect/credentials.json"
  exit 1
fi

# 5. Gerar certificados TLS (opcional)
echo "ğŸ” Configurando certificados TLS..."
if [[ ! -f $DOTFILES_HOME/automation_1password/connect/certs/tls.key ]]; then
  echo "ğŸ“œ Gerando certificados self-signed..."
  mkdir -p $DOTFILES_HOME/automation_1password/connect/certs
  openssl genrsa -out $DOTFILES_HOME/automation_1password/connect/certs/tls.key 2048
  openssl req -new -x509 -key $DOTFILES_HOME/automation_1password/connect/certs/tls.key \
    -out $DOTFILES_HOME/automation_1password/connect/certs/tls.crt -days 365 \
    -subj "/C=BR/ST=SP/L=SÃ£o Paulo/O=Senamfo/CN=localhost"
  echo "âœ… Certificados gerados"
fi

# 6. Parar containers existentes
echo "ğŸ›‘ Parando containers existentes..."
cd $DOTFILES_HOME/automation_1password/connect
docker compose down 2>/dev/null || true

# 7. Iniciar containers
echo "ğŸ³ Iniciando containers 1Password Connect..."
docker compose up -d

# 8. Aguardar inicializaÃ§Ã£o
echo "â³ Aguardando inicializaÃ§Ã£o (60 segundos)..."
sleep 60

# 9. Verificar saÃºde dos containers
echo "ğŸ” Verificando saÃºde dos containers..."
if ! docker ps --filter "name=op-connect" --format "table {{.Names}}\t{{.Status}}" | grep -q "Up"; then
  echo "âŒ Containers nÃ£o estÃ£o rodando"
  docker compose logs
  exit 1
fi

echo "âœ… Containers estÃ£o rodando:"
docker ps --filter "name=op-connect" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

# 10. Testar conectividade
echo "ğŸ§ª Testando conectividade..."
for i in {1..10}; do
  if curl -s http://localhost:8080/health >/dev/null; then
    echo "âœ… API Connect respondendo"
    break
  else
    echo "â³ Aguardando API Connect... ($i/10)"
    sleep 10
  fi
done

# 11. Testar autenticaÃ§Ã£o
echo "ğŸ” Testando autenticaÃ§Ã£o..."
if curl -s -H "Authorization: Bearer $OP_CONNECT_TOKEN" http://localhost:8080/v1/vaults >/dev/null; then
  echo "âœ… AutenticaÃ§Ã£o com 1Password confirmada"
else
  echo "âŒ Falha na autenticaÃ§Ã£o"
  echo "   Verifique se o token estÃ¡ correto e se o servidor estÃ¡ sincronizado"
  exit 1
fi

# 12. Listar vaults disponÃ­veis
echo "ğŸ¦ Vaults disponÃ­veis:"
curl -s -H "Authorization: Bearer $OP_CONNECT_TOKEN" http://localhost:8080/v1/vaults | jq -r '.[] | "  - \(.name) (\(.id))"'

# 13. Log da operaÃ§Ã£o
echo "$(date): Setup completo executado com sucesso" >> $DOTFILES_HOME/automation_1password/logs/automation.log

echo ""
echo "ğŸ‰ 1Password Connect Server configurado com sucesso!"
echo "ğŸŒ API: http://localhost:8080"
echo "ğŸ” HTTPS: https://localhost:8443"
echo "ğŸ“Š Status: Verifique no painel 1Password se aparece 'Sincronizado recentemente'"
echo ""
echo "ğŸ”§ Comandos Ãºteis:"
echo "  - Parar: cd $DOTFILES_HOME/automation_1password/connect && docker compose down"
echo "  - Logs: docker compose logs -f"
echo "  - Status: docker ps --filter name=op-connect"
echo ""
echo "ğŸ§ª Teste a API:"
echo "  curl -H \"Authorization: Bearer \$OP_CONNECT_TOKEN\" http://localhost:8080/v1/vaults"
