# Makefile para Atlas CLI
# Gerenciamento automatizado do Atlas CLI

.PHONY: help install configure pin-extensions status clean backup restore test

# Configura√ß√µes
ATLAS_DIR := $(HOME)/Dotfiles/atlas-cli
CONFIG_DIR := $(HOME)/.config/atlas-cli
LOG_FILE := $(CONFIG_DIR)/atlas.log

# Cores
GREEN := \033[0;32m
BLUE := \033[0;34m
RED := \033[0;31m
YELLOW := \033[1;33m
NC := \033[0m

# Ajuda
help: ## Mostrar ajuda
	@echo "$(BLUE)Atlas CLI - Gerenciamento Automatizado$(NC)"
	@echo "=========================================="
	@echo ""
	@echo "Comandos dispon√≠veis:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""

# Instala√ß√£o
install: ## Instalar Atlas CLI
	@echo "$(BLUE)Instalando Atlas CLI...$(NC)"
	@bash $(ATLAS_DIR)/install-atlas-cli.sh

# Configura√ß√£o
configure: ## Configurar Atlas CLI
	@echo "$(BLUE)Configurando Atlas CLI...$(NC)"
	@bash $(ATLAS_DIR)/configure-atlas-cli.sh

# Pinagem de extens√µes
pin-extensions: ## Fixar extens√µes na barra
	@echo "$(BLUE)Fixando extens√µes...$(NC)"
	@bash $(ATLAS_DIR)/pin-extensoes-macos.sh

# Status
status: ## Verificar status do Atlas CLI
	@echo "$(BLUE)Status do Atlas CLI:$(NC)"
	@if command -v atlas-cli >/dev/null 2>&1; then \
		echo "$(GREEN)‚úÖ Atlas CLI instalado: $$(atlas-cli --version 2>/dev/null || echo 'unknown')$(NC)"; \
		if atlas-cli status >/dev/null 2>&1; then \
			echo "$(GREEN)‚úÖ Atlas CLI autenticado$(NC)"; \
		else \
			echo "$(YELLOW)‚ö†Ô∏è Atlas CLI n√£o autenticado$(NC)"; \
		fi; \
		echo ""; \
		echo "$(BLUE)Extens√µes instaladas:$(NC)"; \
		atlas-cli extensions list 2>/dev/null || echo "Erro ao listar extens√µes"; \
		echo ""; \
		echo "$(BLUE)Extens√µes fixadas:$(NC)"; \
		atlas-cli extensions pinned 2>/dev/null || echo "Erro ao listar extens√µes fixadas"; \
	else \
		echo "$(RED)‚ùå Atlas CLI n√£o instalado$(NC)"; \
	fi

# Limpeza
clean: ## Limpar arquivos tempor√°rios
	@echo "$(BLUE)Limpando arquivos tempor√°rios...$(NC)"
	@rm -rf $(CONFIG_DIR)/*.tmp 2>/dev/null || true
	@rm -rf $(HOME)/.cache/atlas-cli 2>/dev/null || true
	@find $(CONFIG_DIR) -name "*.log" -mtime +7 -delete 2>/dev/null || true
	@echo "$(GREEN)‚úÖ Limpeza conclu√≠da$(NC)"

# Backup
backup: ## Fazer backup das configura√ß√µes
	@echo "$(BLUE)Fazendo backup das configura√ß√µes...$(NC)"
	@mkdir -p $(HOME)/Backups/atlas-cli
	@timestamp=$$(date +"%Y%m%d_%H%M%S"); \
	cp -r $(CONFIG_DIR) $(HOME)/Backups/atlas-cli/atlas-cli_$$timestamp; \
	echo "$(GREEN)‚úÖ Backup criado em: $(HOME)/Backups/atlas-cli/atlas-cli_$$timestamp$(NC)"

# Restaurar
restore: ## Restaurar configura√ß√µes do backup
	@echo "$(BLUE)Backups dispon√≠veis:$(NC)"
	@ls -la $(HOME)/Backups/atlas-cli/ 2>/dev/null || echo "Nenhum backup encontrado"
	@echo ""
	@read -p "Digite o nome do backup para restaurar: " backup_name; \
	if [ -d "$(HOME)/Backups/atlas-cli/$$backup_name" ]; then \
		cp -r "$(HOME)/Backups/atlas-cli/$$backup_name"/* $(CONFIG_DIR)/; \
		echo "$(GREEN)‚úÖ Configura√ß√µes restauradas de: $$backup_name$(NC)"; \
	else \
		echo "$(RED)‚ùå Backup n√£o encontrado: $$backup_name$(NC)"; \
	fi

# Teste
test: ## Testar configura√ß√£o
	@echo "$(BLUE)Testando configura√ß√£o...$(NC)"
	@bash $(ATLAS_DIR)/configure-atlas-cli.sh test

# Setup completo
setup: install configure pin-extensions ## Setup completo (instalar + configurar + fixar)
	@echo "$(GREEN)üéâ Setup completo do Atlas CLI conclu√≠do!$(NC)"

# Atualizar
update: ## Atualizar Atlas CLI
	@echo "$(BLUE)Atualizando Atlas CLI...$(NC)"
	@if command -v brew >/dev/null 2>&1; then \
		brew upgrade atlas-cli; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è Homebrew n√£o encontrado. Atualiza√ß√£o manual necess√°ria.$(NC)"; \
	fi

# Monitor
monitor-start: ## Iniciar monitoramento
	@echo "$(BLUE)Iniciando monitoramento...$(NC)"
	@bash $(ATLAS_DIR)/configure-atlas-cli.sh monitor start

monitor-stop: ## Parar monitoramento
	@echo "$(BLUE)Parando monitoramento...$(NC)"
	@bash $(ATLAS_DIR)/configure-atlas-cli.sh monitor stop

monitor-status: ## Status do monitoramento
	@echo "$(BLUE)Status do monitoramento:$(NC)"
	@bash $(ATLAS_DIR)/configure-atlas-cli.sh monitor status

# Raycast
raycast-setup: ## Configurar integra√ß√£o com Raycast
	@echo "$(BLUE)Configurando integra√ß√£o com Raycast...$(NC)"
	@mkdir -p "$(HOME)/Library/Application Support/Raycast/Scripts/Atlas-CLI"
	@cp $(ATLAS_DIR)/raycast-atlas.sh "$(HOME)/Library/Application Support/Raycast/Scripts/Atlas-CLI/"
	@chmod +x "$(HOME)/Library/Application Support/Raycast/Scripts/Atlas-CLI/raycast-atlas.sh"
	@echo "$(GREEN)‚úÖ Integra√ß√£o com Raycast configurada$(NC)"

# Logs
logs: ## Mostrar logs
	@echo "$(BLUE)Logs do Atlas CLI:$(NC)"
	@if [ -f $(LOG_FILE) ]; then \
		tail -50 $(LOG_FILE); \
	else \
		echo "Nenhum log encontrado"; \
	fi

# Diagn√≥stico
diagnose: ## Diagn√≥stico completo
	@echo "$(BLUE)Diagn√≥stico do Atlas CLI:$(NC)"
	@bash $(ATLAS_DIR)/configure-atlas-cli.sh diagnose

# Padr√£o
.DEFAULT_GOAL := help
